<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Receipt Preview</title>
    <link type="text/css" href="/epson-editor/css/smoothness/jquery-ui-1.8.18.custom.css" rel="stylesheet" />
    <link type="text/css" href="/epson-editor/css/epos-print-editor.css" rel="stylesheet" />
    <script type="text/javascript" src="/epson-editor/js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="/epson-editor/js/jquery-ui-1.8.18.custom.min.js"></script>
    <script type="text/javascript" src="/epson-editor/js/jquery.ui.touch-punch.min.js"></script>
    <script type="text/javascript" src="/epson-editor/js/epos-2.14.0.js"></script>
    <script type="text/javascript" src="/epson-editor/js/epos-print-editor-en.js"></script>
    <style>
        body {
            margin: 0;
            padding: 10px;
            background: #f5f5f5;
            font-family: Arial, sans-serif;
        }
        .preview-container {
            background: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        #preview-paper {
            background: white;
            padding: 20px;
            min-height: 200px;
            overflow-x: auto;
        }
        #preview-paper canvas {
            display: block;
            margin: 0 auto;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="preview-container">
        <div class="loading" id="loading">Loading receipt preview...</div>
        <div id="preview-content" style="display: none;">
            <h2 style="margin-top: 0; margin-bottom: 20px;">Receipt Preview</h2>
            <div id="preview-paper">
                <div id="preview-width">
                    <span>512</span><br />
                    <img src="/epson-editor/img/v.png" alt="" /><img src="/epson-editor/img/h.png" width="510" height="10" alt="" /><img src="/epson-editor/img/v.png" alt="" /><br />
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden elements needed for preview functionality -->
    <canvas class="hidden" id="epos-image" width="1" height="1"></canvas>
    <canvas class="hidden" id="epos-logo" width="1" height="1"></canvas>
    <canvas class="hidden" id="preview-text" width="576" height="192"></canvas>
    <canvas class="hidden preview-line" id="preview-line" width="576" height="48"></canvas>
    <canvas class="hidden" id="preview-page" width="576" height="2400"></canvas>
    <canvas class="hidden" id="preview-area" width="576" height="2400"></canvas>
    <canvas class="hidden" id="preview-rotate" width="576" height="2400"></canvas>
    <div class="hidden preview-break"></div>
    <div class="hidden" id="preview-info">Actual print result from the printer may differ from the preview image.</div>
    
    <!-- Hidden edit sequence container (needed for import) -->
    <div class="hidden" id="edit-sequence"></div>
    <input class="hidden" id="edit-force" type="checkbox" />
    
    <!-- Import dialog elements (must be visible for editor to work) -->
    <div id="import" title="Import" style="display: none;">
        <p>
            Data to be import (ePOS-Print XML)<br />
            <textarea id="import-doc" cols="30" rows="10"></textarea><br />
            <button id="import-apply">Apply</button>
        </p>
        <p>
            Information<br />
            <textarea id="import-info" cols="30" rows="8"></textarea><br />
        </p>
    </div>
    
    <!-- Import confirmation dialog -->
    <div id="import-confirm" title="Confirmation" style="display: none;">
        <p>Data you are editing will be deleted. Do you want to continue?</p>
    </div>
    
    <!-- Hidden setting elements (required by editor script - must match original structure) -->
    <div class="hidden" id="setting">
        <h3>Preview</h3>
        <p>
            Model, Paper width (Liner width)<br />
            <select id="setting-model">
                <option value="tm_t88_80" selected="selected">TM-T88 series (80mm)</option>
                <option value="tm_t88_58">TM-T88 series (58mm)</option>
                <option value="tm_t70_80">TM-T70 series (80mm)</option>
                <option value="tm_t70_m8">TM-T70 series (Multi-language, 80mm)</option>
                <option value="tm_t70_m5">TM-T70 series (Multi-language, 58mm)</option>
                <option value="tm_t90_80">TM-T90 series (80mm)</option>
                <option value="tm_t90_60">TM-T90 series (60mm)</option>
                <option value="tm_t90_58">TM-T90 series (58mm)</option>
                <option value="tm_l90_re">TM-L90 (Receipt)</option>
                <option value="tm_l90_la">TM-L90 (Label)</option>
                <option value="tm_p60_60">TM-P60 series (60mm)</option>
                <option value="tm_p60_58">TM-P60 series (58mm)</option>
                <option value="tm_p60_la">TM-P60 series (Label)</option>
                <option value="tm_p80_48">TM-P80 series(80mm)</option>
                <option value="tm_p80_42">TM-P80 series(80mm, 42 column mode)</option>
                <option value="tm_p20_58">TM-P20 series(58mm)</option>
                <option value="tm_t20_80">TM-T20 series(80mm)</option>
                <option value="tm_t20_58">TM-T20 series(58mm)</option>
                <option value="tm_t82_80">TM-T82 series (80mm)</option>
                <option value="tm_t82_58">TM-T82 series (58mm)</option>
                <option value="tm_t83_80">TM-T83 series (80mm)</option>
                <option value="tm_t83_58">TM-T83 series (58mm)</option>
                <option value="tm_u22_76">TM-U220 (76mm)</option>
                <option value="tm_u22_70">TM-U220 (70mm)</option>
                <option value="tm_u22_58">TM-U220 (58mm)</option>
                <option value="tm_u33_76">TM-U330 (76mm)</option>
                <option value="tm_u33_70">TM-U330 (70mm)</option>
                <option value="tm_u33_58">TM-U330 (58mm)</option>
                <option value="tm_h60_re">TM-H6000 series (Receipt)</option>
                <option value="tm_m10_58">TM-m10 series (58mm)</option>
                <option value="tm_m30_80">TM-m30 series (80mm)</option>
                <option value="tm_m30_58">TM-m30 series (58mm)</option>
                <option value="tm_m50_80">TM-m50 series (80mm)</option>
                <option value="tm_m50_58">TM-m50 series (58mm)</option>
            </select>
            <span class="hidden">
                <input id="setting-width" type="text" maxlength="2" size="2" value="80" />mm
            </span>
        </p>
        <br />
        <h3>Print</h3>
        <p>
            IP address of ePOS-Print supported printer<br />
            <input id="setting-ipaddr" type="text" value="192.168.192.168" />
        </p>
        <p>
            Device ID of the target printer<br />
            <input id="setting-devid" type="text" value="local_printer" />
        </p>
        <p>
            Print timeout (milliseconds)<br />
            <input id="setting-timeout" type="text" value="60000" />
        </p>
        <p>
            <input id="setting-status" type="checkbox" /><label for="setting-status">Monitor the status</label><br />
            &nbsp;&nbsp;&nbsp;Drawer open status
            <select id="setting-drawer">
                <option value="low" selected="selected">Low</option>
                <option value="high">High</option>
            </select>
        </p>
        <p>
            <input id="setting-jobid" type="checkbox" /><label for="setting-jobid">Use print job ID [v4.1-]</label>
        </p>
        <p>
            <input id="setting-https" type="checkbox" /><label for="setting-https">Use HTTPS</label>
        </p>
    </div>

    <!-- Load editor script AFTER all required elements are in DOM -->
    <script type="text/javascript" src="/epson-editor/js/epos-print-editor.js"></script>
    
    <script>
        // Get receipt ID from URL parameter
        function getReceiptId() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('receipt_id') || urlParams.get('id');
            } catch(e) {
                console.error('Error getting receipt ID:', e);
            }
            return null;
        }

        // Fetch XML from web endpoint (uses session-based auth)
        async function fetchXmlData(receiptId) {
            try {
                const response = await fetch(`/receipts/${receiptId}/xml`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/xml',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    credentials: 'include', // Include cookies for session-based authentication
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const xml = await response.text();
                console.log('Fetched XML length:', xml.length);
                console.log('First 200 chars of XML:', xml.substring(0, 200));
                return xml;
            } catch(e) {
                console.error('Error fetching XML:', e);
                throw e;
            }
        }

        // Wait for editor scripts to load
        $(document).ready(function() {
            // Wait a bit longer for the editor script to fully initialize
            setTimeout(async function() {
                const receiptId = getReceiptId();
                
                if (!receiptId) {
                    document.getElementById('loading').textContent = 'No receipt ID provided. Add ?receipt_id=1 to the URL.';
                    return;
                }

                let xmlData;
                try {
                    document.getElementById('loading').textContent = 'Loading receipt XML...';
                    xmlData = await fetchXmlData(receiptId);
                } catch(e) {
                    document.getElementById('loading').textContent = 'Error loading receipt: ' + e.message;
                    console.error('Failed to fetch XML:', e);
                    return;
                }
                
                if (!xmlData) {
                    document.getElementById('loading').textContent = 'No receipt data received.';
                    return;
                }

                try {
                    // Validate XML structure first
                    try {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlData, 'text/xml');
                        const parseError = xmlDoc.querySelector('parsererror');
                        if (parseError) {
                            throw new Error('XML Parse Error: ' + parseError.textContent);
                        }
                        console.log('✓ XML is valid');
                    } catch(e) {
                        console.error('✗ XML validation error:', e);
                        document.getElementById('loading').textContent = 'Invalid XML: ' + e.message;
                        return;
                    }

                    // Set model (default to TM-m30 series 80mm) - must be done after script init
                    const modelSelect = document.getElementById('setting-model');
                    if (modelSelect) {
                        modelSelect.value = 'tm_m30_80';
                        // Trigger change event
                        const event = new Event('change', { bubbles: true });
                        modelSelect.dispatchEvent(event);
                        console.log('✓ Model set to tm_m30_80');
                    }

                    // Custom import function that creates DOM structure directly
                    // This bypasses the need for edit-left templates
                    function importXmlToEditSequence(xmlString) {
                        const editSequence = document.getElementById('edit-sequence');
                        if (!editSequence) {
                            throw new Error('edit-sequence element not found');
                        }
                        
                        // Clear existing items
                        editSequence.innerHTML = '';
                        
                        // Parse XML
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
                        const parseError = xmlDoc.querySelector('parsererror');
                        if (parseError) {
                            throw new Error('XML Parse Error: ' + parseError.textContent);
                        }
                        
                        const eposPrint = xmlDoc.querySelector('epos-print');
                        if (!eposPrint) {
                            throw new Error('No epos-print element found');
                        }
                        
                        // Handle force attribute
                        const editForce = document.getElementById('edit-force');
                        if (editForce) {
                            if (eposPrint.getAttribute('force') === 'true' || eposPrint.getAttribute('force') === '1') {
                                editForce.checked = true;
                            } else {
                                editForce.checked = false;
                            }
                        }
                        
                        // Get all elements to process
                        const elements = xmlDoc.querySelectorAll('epos-print > *, epos-print > page > *');
                        
                        elements.forEach(function(element) {
                            const tagName = element.tagName.toLowerCase();
                            let li;
                            
                            switch(tagName) {
                                case 'text':
                                    // Handle text state attributes first (these are separate elements)
                                    if (element.hasAttribute('align')) {
                                        const alignLi = document.createElement('li');
                                        alignLi.className = 'epos-text-align edit-icon ui-state-default';
                                        const alignInput = document.createElement('input');
                                        alignInput.className = 'attr-text-align';
                                        alignInput.type = 'hidden';
                                        alignInput.value = element.getAttribute('align');
                                        alignLi.appendChild(alignInput);
                                        editSequence.appendChild(alignLi);
                                    }
                                    
                                    if (element.hasAttribute('linespc')) {
                                        const linespcLi = document.createElement('li');
                                        linespcLi.className = 'epos-text-linespc edit-icon ui-state-default';
                                        const linespcInput = document.createElement('input');
                                        linespcInput.className = 'attr-text-linespc';
                                        linespcInput.type = 'hidden';
                                        linespcInput.value = element.getAttribute('linespc');
                                        linespcLi.appendChild(linespcInput);
                                        editSequence.appendChild(linespcLi);
                                    }
                                    
                                    if (element.hasAttribute('rotate')) {
                                        const rotateLi = document.createElement('li');
                                        rotateLi.className = 'epos-text-rotate edit-icon ui-state-default';
                                        const rotateInput = document.createElement('input');
                                        rotateInput.className = 'attr-text-rotate';
                                        rotateInput.type = 'checkbox';
                                        rotateInput.checked = element.getAttribute('rotate') === 'true' || element.getAttribute('rotate') === '1';
                                        rotateLi.appendChild(rotateInput);
                                        editSequence.appendChild(rotateLi);
                                    }
                                    
                                    // Handle text size if specified
                                    if (element.hasAttribute('width') || element.hasAttribute('height')) {
                                        const sizeLi = document.createElement('li');
                                        sizeLi.className = 'epos-text-size edit-icon ui-state-default';
                                        const widthInput = document.createElement('input');
                                        widthInput.className = 'attr-text-width';
                                        widthInput.type = 'hidden';
                                        widthInput.value = element.getAttribute('width') || '1';
                                        const heightInput = document.createElement('input');
                                        heightInput.className = 'attr-text-height';
                                        heightInput.type = 'hidden';
                                        heightInput.value = element.getAttribute('height') || '1';
                                        sizeLi.appendChild(widthInput);
                                        sizeLi.appendChild(heightInput);
                                        editSequence.appendChild(sizeLi);
                                    }
                                    
                                    // Handle text style if specified
                                    if (element.hasAttribute('reverse') || element.hasAttribute('ul') || element.hasAttribute('em')) {
                                        const styleLi = document.createElement('li');
                                        styleLi.className = 'epos-text-style edit-icon ui-state-default';
                                        const reverseInput = document.createElement('input');
                                        reverseInput.className = 'attr-text-reverse';
                                        reverseInput.type = 'checkbox';
                                        reverseInput.checked = element.getAttribute('reverse') === 'true' || element.getAttribute('reverse') === '1';
                                        const ulInput = document.createElement('input');
                                        ulInput.className = 'attr-text-ul';
                                        ulInput.type = 'checkbox';
                                        ulInput.checked = element.getAttribute('ul') === 'true' || element.getAttribute('ul') === '1';
                                        const emInput = document.createElement('input');
                                        emInput.className = 'attr-text-em';
                                        emInput.type = 'checkbox';
                                        emInput.checked = element.getAttribute('em') === 'true' || element.getAttribute('em') === '1';
                                        styleLi.appendChild(reverseInput);
                                        styleLi.appendChild(ulInput);
                                        styleLi.appendChild(emInput);
                                        editSequence.appendChild(styleLi);
                                    }
                                    
                                    // Create the actual text element
                                    li = document.createElement('li');
                                    li.className = 'epos-text edit-icon ui-state-default';
                                    const textInput = document.createElement('input');
                                    textInput.className = 'attr-text-data';
                                    textInput.type = 'text'; // Use 'text' instead of 'hidden' - jQuery .val() works better
                                    textInput.style.display = 'none'; // Hide it visually instead
                                    
                                    // Get text content - handle both textContent and innerText for compatibility
                                    let textContent = '';
                                    if (element.textContent !== undefined) {
                                        textContent = element.textContent;
                                    } else if (element.innerText !== undefined) {
                                        textContent = element.innerText;
                                    } else if (element.firstChild && element.firstChild.nodeValue) {
                                        textContent = element.firstChild.nodeValue;
                                    }
                                    
                                    // Trim and clean up the text
                                    textContent = textContent.trim();
                                    textInput.value = textContent;
                                    
                                    // Debug: log text content (first 50 chars) for non-empty text
                                    if (textContent.length > 0) {
                                        console.log('  Text element:', JSON.stringify(textContent.substring(0, 50)));
                                    }
                                    li.appendChild(textInput);
                                    editSequence.appendChild(li);
                                    break;
                                    
                                case 'feed':
                                    const feedLi = document.createElement('li');
                                    feedLi.className = 'epos-feed-line edit-icon ui-state-default';
                                    const feedInput = document.createElement('input');
                                    feedInput.className = 'attr-feed-line';
                                    feedInput.type = 'hidden';
                                    feedInput.value = element.getAttribute('line') || '1';
                                    feedLi.appendChild(feedInput);
                                    editSequence.appendChild(feedLi);
                                    break;
                                    
                                case 'logo':
                                    const logoLi = document.createElement('li');
                                    logoLi.className = 'epos-logo edit-icon ui-state-default';
                                    
                                    // Create img element - required by drawPreview()
                                    // The drawIcon function expects an img element that's already loaded
                                    const logoImg = document.createElement('img');
                                    logoImg.alt = 'logo';
                                    
                                    // Try to use the logo from the epos-logo canvas first
                                    const logoCanvas = document.getElementById('epos-logo');
                                    if (logoCanvas && logoCanvas.width > 1 && logoCanvas.height > 1) {
                                        // Canvas is initialized, use it
                                        logoImg.src = logoCanvas.toDataURL();
                                    } else {
                                        // Create a simple placeholder image using canvas
                                        const placeholderCanvas = document.createElement('canvas');
                                        placeholderCanvas.width = 32;
                                        placeholderCanvas.height = 32;
                                        const ctx = placeholderCanvas.getContext('2d');
                                        // Draw a simple logo placeholder (square with border)
                                        ctx.strokeStyle = '#000';
                                        ctx.lineWidth = 2;
                                        ctx.strokeRect(4, 4, 24, 24);
                                        ctx.fillStyle = '#000';
                                        ctx.fillRect(8, 8, 16, 16);
                                        logoImg.src = placeholderCanvas.toDataURL();
                                    }
                                    
                                    logoLi.appendChild(logoImg);
                                    
                                    const logoKey1Input = document.createElement('input');
                                    logoKey1Input.className = 'attr-logo-key1';
                                    logoKey1Input.type = 'hidden';
                                    logoKey1Input.value = element.getAttribute('key1') || '34';
                                    const logoKey2Input = document.createElement('input');
                                    logoKey2Input.className = 'attr-logo-key2';
                                    logoKey2Input.type = 'hidden';
                                    logoKey2Input.value = element.getAttribute('key2') || '48';
                                    logoLi.appendChild(logoKey1Input);
                                    logoLi.appendChild(logoKey2Input);
                                    editSequence.appendChild(logoLi);
                                    break;
                                    
                                case 'cut':
                                    const cutLi = document.createElement('li');
                                    cutLi.className = 'epos-cut edit-icon ui-state-default';
                                    const cutTypeInput = document.createElement('input');
                                    cutTypeInput.className = 'attr-cut-type';
                                    cutTypeInput.type = 'hidden';
                                    cutTypeInput.value = element.getAttribute('type') || 'feed';
                                    cutLi.appendChild(cutTypeInput);
                                    editSequence.appendChild(cutLi);
                                    break;
                                    
                                // Add more cases as needed for other elements
                            }
                        });
                        
                        console.log('✓ Imported', editSequence.children.length, 'elements into edit-sequence');
                        return editSequence.children.length;
                    }
                    
                    // Wait a bit for the editor to be ready, then import
                    setTimeout(function() {
                        try {
                            console.log('✓ Starting custom XML import');
                            const itemCount = importXmlToEditSequence(xmlData);
                            
                            console.log('✓ Import complete. Item count:', itemCount);
                            
                            // Debug: Log what was created
                            const editSequence = document.getElementById('edit-sequence');
                            if (editSequence) {
                                console.log('✓ edit-sequence element found');
                                console.log('✓ edit-sequence children:', editSequence.children.length);
                                console.log('✓ edit-sequence HTML:', editSequence.innerHTML.substring(0, 500));
                                
                                // Check if jQuery can find the elements
                                if (typeof $ !== 'undefined') {
                                    const jqElements = $('#edit-sequence li');
                                    console.log('✓ jQuery found', jqElements.length, 'li elements');
                                    jqElements.each(function(index) {
                                        console.log('  Element', index, ':', $(this).attr('class'));
                                    });
                                }
                            } else {
                                console.error('✗ edit-sequence element not found!');
                            }
                            
                            if (itemCount === 0) {
                                console.warn('⚠ No items imported from XML');
                                document.getElementById('loading').textContent = 'No items found in XML.';
                                return;
                            }
                            
                            // Wait for any images to load, then draw preview
                            const logoImages = editSequence ? editSequence.querySelectorAll('img') : [];
                            let imagesToLoad = logoImages.length;
                            console.log('✓ Found', imagesToLoad, 'logo images to load');
                            
                            if (imagesToLoad === 0) {
                                // No images to wait for, draw immediately
                                drawPreviewNow();
                            } else {
                                // Wait for all images to load
                                logoImages.forEach(function(img) {
                                    if (img.complete) {
                                        imagesToLoad--;
                                        if (imagesToLoad === 0) {
                                            drawPreviewNow();
                                        }
                                    } else {
                                        img.onload = function() {
                                            imagesToLoad--;
                                            if (imagesToLoad === 0) {
                                                drawPreviewNow();
                                            }
                                        };
                                        img.onerror = function() {
                                            // Image failed to load, but continue anyway
                                            imagesToLoad--;
                                            if (imagesToLoad === 0) {
                                                drawPreviewNow();
                                            }
                                        };
                                    }
                                });
                                
                                // Timeout fallback - draw after 2 seconds even if images haven't loaded
                                setTimeout(function() {
                                    if (imagesToLoad > 0) {
                                        console.warn('⚠ Some images did not load, drawing preview anyway');
                                        imagesToLoad = 0;
                                        drawPreviewNow();
                                    }
                                }, 2000);
                            }
                            
                            function drawPreviewNow() {
                                try {
                                    // Verify elements are still there before drawing
                                    const editSequence = document.getElementById('edit-sequence');
                                    if (!editSequence || editSequence.children.length === 0) {
                                        console.error('✗ No elements in edit-sequence before drawPreview');
                                        document.getElementById('loading').textContent = 'No elements to preview.';
                                        return;
                                    }
                                    
                                    console.log('✓ About to call drawPreview with', editSequence.children.length, 'elements');
                                    
                                    // Make sure preview-content is visible BEFORE drawing (some functions might check visibility)
                                    const previewContent = document.getElementById('preview-content');
                                    const previewPaper = document.getElementById('preview-paper');
                                    
                                    // Clear any existing canvas elements
                                    if (previewPaper) {
                                        const existingCanvases = previewPaper.querySelectorAll('canvas');
                                        console.log('✓ Clearing', existingCanvases.length, 'existing canvas elements');
                                        existingCanvases.forEach(canvas => canvas.remove());
                                    }
                                    
                                    // Ensure font variable is set (required by drawChar)
                                    // The font variable should be defined in epos-print-editor-en.js
                                    if (typeof font === 'undefined' && typeof window.font === 'undefined') {
                                        // Fallback if font variable not loaded
                                        window.font = '"Courier New", monospace';
                                        console.log('✓ Set font variable to:', window.font);
                                    } else if (typeof font !== 'undefined') {
                                        // Make sure it's accessible globally
                                        window.font = font;
                                        console.log('✓ Font variable available:', window.font);
                                    }
                                    
                                    // Draw the preview
                                    if (typeof window.drawPreview === 'function') {
                                        console.log('✓ Calling drawPreview()');
                                        window.drawPreview();
                                        
                                        // Check if preview was actually drawn
                                        const canvasElements = previewPaper ? previewPaper.querySelectorAll('canvas') : [];
                                        console.log('✓ Preview drawn. Canvas elements:', canvasElements.length);
                                        
                                        // Verify canvas elements have content
                                        if (canvasElements.length > 0) {
                                            let canvasesWithContent = 0;
                                            canvasElements.forEach((canvas, index) => {
                                                if (canvas.width > 0 && canvas.height > 0) {
                                                    const ctx = canvas.getContext('2d');
                                                    const imageData = ctx.getImageData(0, 0, Math.min(canvas.width, 10), Math.min(canvas.height, 10));
                                                    const hasContent = imageData.data.some((val, i) => i % 4 !== 3 && val !== 0); // Check if any pixel is not transparent
                                                    if (hasContent) {
                                                        canvasesWithContent++;
                                                    }
                                                    if (index < 3) {
                                                        console.log('  Canvas', index, ':', canvas.width, 'x', canvas.height, hasContent ? 'has content' : 'empty');
                                                    }
                                                }
                                            });
                                            console.log('✓ Canvases with content:', canvasesWithContent, 'of', canvasElements.length);
                                            
                                            // Debug: Check text input values that jQuery should be reading
                                            if (typeof $ !== 'undefined') {
                                                const textElements = $('#edit-sequence .epos-text');
                                                console.log('✓ jQuery found', textElements.length, 'epos-text elements');
                                                textElements.each(function(index) {
                                                    if (index < 5) {
                                                        const textValue = $(this).find('.attr-text-data').val();
                                                        console.log('  Text element', index, 'value:', JSON.stringify(textValue ? textValue.substring(0, 30) : ''));
                                                    }
                                                });
                                            }
                                            
                                            // If no canvases have content, there might be an issue
                                            if (canvasesWithContent === 0 && canvasElements.length > 0) {
                                                console.warn('⚠ All canvas elements appear to be empty - preview may not render correctly');
                                                console.warn('⚠ This might indicate that text data is not being read correctly by drawPreview()');
                                            }
                                        }
                                        
                                        // Always show preview content, even if empty (for debugging)
                                        document.getElementById('loading').style.display = 'none';
                                        if (previewContent) {
                                            previewContent.style.display = 'block';
                                        }
                                        
                                        // If no canvas content, show a message
                                        if (canvasElements.length === 0) {
                                            console.warn('⚠ No canvas elements were created');
                                            const previewPaper = document.getElementById('preview-paper');
                                            if (previewPaper) {
                                                previewPaper.innerHTML += '<p style="color: #999; padding: 20px; text-align: center;">No preview content generated. Check console for details.</p>';
                                            }
                                        } else if (canvasElements.length > 0) {
                                            // Check if any canvas has visible content
                                            let hasVisibleContent = false;
                                            canvasElements.forEach((canvas) => {
                                                if (canvas.width > 0 && canvas.height > 0) {
                                                    try {
                                                        const ctx = canvas.getContext('2d');
                                                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                                                        const hasContent = imageData.data.some((val, i) => i % 4 !== 3 && val !== 0);
                                                        if (hasContent) {
                                                            hasVisibleContent = true;
                                                        }
                                                    } catch(e) {
                                                        // Ignore errors
                                                    }
                                                }
                                            });
                                            
                                            if (!hasVisibleContent) {
                                                console.warn('⚠ Canvas elements exist but appear to be empty');
                                                const previewPaper = document.getElementById('preview-paper');
                                                if (previewPaper) {
                                                    previewPaper.innerHTML += '<p style="color: #999; padding: 20px; text-align: center;">Preview canvases created but appear empty. Check console for details.</p>';
                                                }
                                            }
                                        }
                                    } else {
                                        console.error('✗ drawPreview function not found');
                                        document.getElementById('loading').textContent = 'Preview function not available.';
                                        document.getElementById('loading').style.display = 'block';
                                    }
                                } catch(e) {
                                    console.error('✗ Error drawing preview:', e);
                                    console.error('✗ Stack trace:', e.stack);
                                    document.getElementById('loading').textContent = 'Error rendering preview: ' + e.message;
                                    document.getElementById('loading').style.display = 'block';
                                    // Still try to show preview content
                                    const previewContent = document.getElementById('preview-content');
                                    if (previewContent) {
                                        previewContent.style.display = 'block';
                                    }
                                }
                            }
                            
                        } catch(e) {
                            console.error('✗ Error importing XML:', e);
                            document.getElementById('loading').textContent = 'Error importing XML: ' + e.message;
                        }
                    }, 500);

                } catch(e) {
                    console.error('✗ Error importing XML:', e);
                    document.getElementById('loading').textContent = 'Error loading receipt: ' + e.message;
                }
            }, 1000); // Wait 1 second for editor script to initialize
        });
    </script>
</body>
</html>
