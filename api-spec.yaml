openapi: 3.0.3
info:
  title: POS Stripe Connect API
  description: |
    API for managing Stripe Connect integration for POS systems.

    This API provides endpoints for:
    - User authentication and authorization
    - Store management
    - Customer management
    - POS device registration and management
    - POS session management (Kassasystemforskriften compliance)
    - POS event logging (audit trail)
    - POS transaction operations (void, correction)
    - Receipt generation and management
    - Receipt printer configuration and management
    - Product and inventory management
    - SAF-T file generation (Norwegian tax compliance)
    - Terminal operations (connection tokens and payment intents)

    All endpoints (except login and webhooks) require Bearer token authentication.
    Requests are automatically scoped to the authenticated user's accessible stores.
  version: 1.0.0
  contact:
    name: API Support
    email: support@visivo.no
  license:
    name: Proprietary

servers:
  - url: https://pos.visivo.no/api
    description: Production server
  - url: http://pos-stripe.test/api
    description: Local development server

tags:
  - name: Authentication
    description: User authentication and authorization
  - name: Stores
    description: Store management operations
  - name: Customers
    description: Customer management operations
  - name: POS Devices
    description: POS device registration and management (vendor-agnostic)
  - name: POS Sessions
    description: POS session management (Kassasystemforskriften compliance)
  - name: POS Events
    description: POS event logging (audit trail)
  - name: POS Transactions
    description: POS transaction operations (void, correction)
  - name: Receipts
    description: Receipt generation and management
  - name: Receipt Printers
    description: Receipt printer configuration and management
  - name: Purchases
    description: POS purchase processing with multiple payment methods
  - name: Products
    description: Product management for POS
  - name: Collections
    description: Product collections/categories management
  - name: Inventory
    description: Inventory management operations
  - name: SAF-T
    description: SAF-T file generation (Norwegian tax compliance)
  - name: Terminals
    description: Terminal locations and readers management (Stripe-specific)
  - name: Webhooks
    description: Stripe webhook endpoints

paths:
  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login user
      description: Authenticate user and receive API token
      operationId: login
      security: []  # Public endpoint - no authentication required
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: admin@pos.visivo.no
                password:
                  type: string
                  format: password
                  example: admin
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                default:
                  value:
                    message: The provided credentials are incorrect.
                    errors:
                      email:
                        - The provided credentials are incorrect.

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user
      description: Get authenticated user information and accessible stores
      operationId: getCurrentUser
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout user
      description: Revoke current authentication token
      operationId: logout
      responses:
        '200':
          description: Successfully logged out
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /auth/logout-all:
    post:
      tags:
        - Authentication
      summary: Logout from all devices
      description: Revoke all authentication tokens for the user
      operationId: logoutAll
      responses:
        '200':
          description: Successfully logged out from all devices
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out from all devices successfully
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /stores:
    get:
      tags:
        - Stores
      summary: List stores
      description: Get all stores accessible by the authenticated user
      operationId: listStores
      responses:
        '200':
          description: List of stores
          content:
            application/json:
              schema:
                type: object
                properties:
                  stores:
                    type: array
                    items:
                      $ref: '#/components/schemas/Store'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /stores/current:
    get:
      tags:
        - Stores
      summary: Get current store
      description: Get the authenticated user's default store
      operationId: getCurrentStore
      responses:
        '200':
          description: Store information
          content:
            application/json:
              schema:
                type: object
                properties:
                  store:
                    $ref: '#/components/schemas/Store'
        '404':
          description: No store assigned to user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                default:
                  value:
                    message: No store assigned to this user
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    put:
      tags:
        - Stores
      summary: Change current store
      description: Change the authenticated user's current/default store
      operationId: changeCurrentStore
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: >
                Either 'store_id' or 'store_slug' is required. The server
                will reject requests that do not provide at least one of them.
              properties:
                store_id:
                  type: integer
                  description: Store ID to set as current
                  example: 1
                store_slug:
                  type: string
                  description: Store slug to set as current (alternative to store_id)
                  example: my-store
      responses:
        '200':
          description: Current store changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Current store changed successfully
                  store:
                    $ref: '#/components/schemas/Store'
        '403':
          description: User does not have access to this store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                default:
                  value:
                    message: You do not have access to this store
        '404':
          description: Store not found or no store assigned to user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                default:
                  value:
                    message: Store not found
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    patch:
      tags:
        - Stores
      summary: Change current store (partial)
      description: Change the authenticated user's current/default store (alternative to PUT)
      operationId: patchCurrentStore
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: >
                Either 'store_id' or 'store_slug' is required. The server
                will reject requests that do not provide at least one of them.
              properties:
                store_id:
                  type: integer
                  description: Store ID to set as current
                  example: 1
                store_slug:
                  type: string
                  description: Store slug to set as current (alternative to store_id)
                  example: my-store
      responses:
        '200':
          description: Current store changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Current store changed successfully
                  store:
                    $ref: '#/components/schemas/Store'
        '403':
          description: User does not have access to this store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                default:
                  value:
                    message: You do not have access to this store
        '404':
          description: Store not found or no store assigned to user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                default:
                  value:
                    message: Store not found
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /stores/{slug}:
    get:
      tags:
        - Stores
      summary: Get store by slug
      description: Get a specific store by its slug
      operationId: getStore
      parameters:
        - name: slug
          in: path
          required: true
          description: Store slug
          schema:
            type: string
          example: my-store
      responses:
        '200':
          description: Store information
          content:
            application/json:
              schema:
                type: object
                properties:
                  store:
                    $ref: '#/components/schemas/Store'
        '403':
          description: User does not have access to this store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                default:
                  value:
                    message: You do not have access to this store
        '404':
          description: Store not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                default:
                  value:
                    message: Store not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-devices:
    get:
      tags:
        - POS Devices
      summary: List POS devices
      description: Get all POS devices for the current store
      operationId: listPosDevices
      responses:
        '200':
          description: List of POS devices
          content:
            application/json:
              schema:
                type: object
                properties:
                  devices:
                    type: array
                    items:
                      $ref: '#/components/schemas/PosDevice'
        '404':
          description: Store not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    post:
      tags:
        - POS Devices
      summary: Register POS device
      description: Register a new POS device using device information from device_info_plus
      operationId: registerPosDevice
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - device_identifier
                - device_name
                - platform
              properties:
                device_identifier:
                  type: string
                  description: "Unique device identifier (iOS: identifierForVendor, Android: androidId)"
                  example: ABC123-DEF456-GHI789
                device_name:
                  type: string
                  description: "Human-readable device name (iOS: name, Android: device)"
                  example: Jan's iPad
                platform:
                  type: string
                  enum: [ios, android]
                  description: Device platform
                  example: ios
                device_model:
                  type: string
                  nullable: true
                  description: Device model
                  example: iPad
                device_brand:
                  type: string
                  nullable: true
                  description: Device brand (Android only)
                  example: Apple
                device_manufacturer:
                  type: string
                  nullable: true
                  description: Device manufacturer (Android only)
                  example: Apple
                device_product:
                  type: string
                  nullable: true
                  description: Device product (Android only)
                device_hardware:
                  type: string
                  nullable: true
                  description: Device hardware (Android only)
                machine_identifier:
                  type: string
                  nullable: true
                  description: "Machine identifier (iOS: utsname.machine)"
                  example: "iPad13,1"
                system_name:
                  type: string
                  nullable: true
                  description: "System name (iOS: systemName)"
                  example: iOS
                system_version:
                  type: string
                  nullable: true
                  description: System version
                  example: 17.0
                vendor_identifier:
                  type: string
                  nullable: true
                  description: "Vendor identifier (iOS: identifierForVendor)"
                android_id:
                  type: string
                  nullable: true
                  description: Android ID (Android only)
                serial_number:
                  type: string
                  nullable: true
                  description: Serial number (if available)
                device_metadata:
                  type: object
                  nullable: true
                  description: Additional device metadata (battery, storage, etc.)
                  additionalProperties: true
      responses:
        '201':
          description: POS device registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: POS device registered successfully
                  device:
                    $ref: '#/components/schemas/PosDevice'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-devices/{id}:
    get:
      tags:
        - POS Devices
      summary: Get POS device
      description: Get a specific POS device by ID
      operationId: getPosDevice
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: POS device information
          content:
            application/json:
              schema:
                type: object
                properties:
                  device:
                    $ref: '#/components/schemas/PosDevice'
        '404':
          description: Device not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    put:
      tags:
        - POS Devices
      summary: Update POS device
      description: Update POS device information
      operationId: updatePosDevice
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                device_name:
                  type: string
                device_model:
                  type: string
                  nullable: true
                device_brand:
                  type: string
                  nullable: true
                device_manufacturer:
                  type: string
                  nullable: true
                device_product:
                  type: string
                  nullable: true
                device_hardware:
                  type: string
                  nullable: true
                machine_identifier:
                  type: string
                  nullable: true
                system_name:
                  type: string
                  nullable: true
                system_version:
                  type: string
                  nullable: true
                vendor_identifier:
                  type: string
                  nullable: true
                android_id:
                  type: string
                  nullable: true
                serial_number:
                  type: string
                  nullable: true
                device_status:
                  type: string
                  enum: [active, inactive, maintenance, offline]
                device_metadata:
                  type: object
                  nullable: true
                  additionalProperties: true
      responses:
        '200':
          description: Device updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: POS device updated successfully
                  device:
                    $ref: '#/components/schemas/PosDevice'
        '404':
          description: Device not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    patch:
      tags:
        - POS Devices
      summary: Update POS device (partial)
      description: Partially update POS device information
      operationId: patchPosDevice
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                device_name:
                  type: string
                device_status:
                  type: string
                  enum: [active, inactive, maintenance, offline]
                device_metadata:
                  type: object
                  nullable: true
                  additionalProperties: true
      responses:
        '200':
          description: Device updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: POS device updated successfully
                  device:
                    $ref: '#/components/schemas/PosDevice'
        '404':
          description: Device not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-devices/{id}/heartbeat:
    post:
      tags:
        - POS Devices
      summary: Update device heartbeat
      description: Update device last_seen_at timestamp and optionally status/metadata
      operationId: updateDeviceHeartbeat
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                device_status:
                  type: string
                  enum: [active, inactive, maintenance, offline]
                device_metadata:
                  type: object
                  nullable: true
                  description: Additional metadata (battery level, storage, etc.)
                  additionalProperties: true
      responses:
        '200':
          description: Heartbeat updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Device heartbeat updated
                  device:
                    $ref: '#/components/schemas/PosDevice'
        '404':
          description: Device not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-devices/{id}/start:
    post:
      tags:
        - POS Devices
      summary: Log application start
      description: Log POS application start event (13001) for audit trail compliance
      operationId: logApplicationStart
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Application start logged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Application start logged successfully
                  device:
                    $ref: '#/components/schemas/PosDevice'
                  current_session:
                    type: object
                    nullable: true
                    properties:
                      id:
                        type: integer
                      session_number:
                        type: string
        '404':
          description: Device not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-devices/{id}/shutdown:
    post:
      tags:
        - POS Devices
      summary: Log application shutdown
      description: Log POS application shutdown event (13002) for audit trail compliance
      operationId: logApplicationShutdown
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Application shutdown logged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Application shutdown logged successfully
                  device:
                    $ref: '#/components/schemas/PosDevice'
        '404':
          description: Device not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-devices/{id}/cash-drawer/open:
    post:
      tags:
        - POS Devices
      summary: Open cash drawer
      description: Log cash drawer open event (13005). Supports nullinnslag (drawer open without sale) - mandatory per Kassasystemforskriften § 2-2
      operationId: openCashDrawer
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                pos_session_id:
                  type: integer
                  nullable: true
                  description: POS session ID (auto-detected if not provided)
                related_charge_id:
                  type: integer
                  nullable: true
                  description: Charge ID if drawer opened with sale
                nullinnslag:
                  type: boolean
                  nullable: true
                  description: True if drawer opened without sale (mandatory to log per § 2-2)
                  example: false
                reason:
                  type: string
                  nullable: true
                  maxLength: 500
                  description: Reason for nullinnslag (if applicable)
      responses:
        '200':
          description: Cash drawer open logged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Cash drawer open logged successfully
                  event:
                    type: object
                    properties:
                      nullinnslag:
                        type: boolean
                      session_id:
                        type: integer
                        nullable: true
        '400':
          description: Active session required for nullinnslag
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Device not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-devices/{id}/cash-drawer/close:
    post:
      tags:
        - POS Devices
      summary: Close cash drawer
      description: Log cash drawer close event (13006) for audit trail compliance
      operationId: closeCashDrawer
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                pos_session_id:
                  type: integer
                  nullable: true
                  description: POS session ID (auto-detected if not provided)
      responses:
        '200':
          description: Cash drawer close logged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Cash drawer close logged successfully
        '404':
          description: Device not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-sessions:
    get:
      tags:
        - POS Sessions
      summary: List POS sessions
      description: Get all POS sessions for the current store
      operationId: listPosSessions
      parameters:
        - name: status
          in: query
          description: Filter by status (open, closed, abandoned)
          required: false
          schema:
            type: string
            enum: [open, closed, abandoned]
        - name: date
          in: query
          description: Filter by opening date (YYYY-MM-DD)
          required: false
          schema:
            type: string
            format: date
        - name: pos_device_id
          in: query
          description: Filter by POS device ID
          required: false
          schema:
            type: integer
        - name: per_page
          in: query
          description: Number of items per page
          required: false
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of POS sessions
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      $ref: '#/components/schemas/PosSession'
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'
        '404':
          description: Store not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-sessions/current:
    get:
      tags:
        - POS Sessions
      summary: Get current open session
      description: Get the current open session for a POS device
      operationId: getCurrentPosSession
      parameters:
        - name: pos_device_id
          in: query
          required: true
          description: POS device ID
          schema:
            type: integer
      responses:
        '200':
          description: Current session information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PosSessionWithCharges'
        '404':
          description: Store not found or no open session
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-sessions/open:
    post:
      tags:
        - POS Sessions
      summary: Open POS session
      description: Open a new POS session. Automatically logs event 13020 (Session opened)
      operationId: openPosSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - pos_device_id
              properties:
                pos_device_id:
                  type: integer
                  description: POS device ID
                  example: 1
                opening_balance:
                  type: integer
                  nullable: true
                  description: Opening cash balance in øre
                  minimum: 0
                  example: 0
                opening_notes:
                  type: string
                  nullable: true
                  maxLength: 1000
                  description: Free-text notes for session opening (e.g., shift information, initial observations, cashier notes). Human-readable text field for cashiers/managers to document session start.
                  example: "Morning shift - Starting with 500 kr in drawer"
                opening_data:
                  type: object
                  nullable: true
                  description: Additional opening metadata (device info, app version, location, etc.). Flexible object for storing any additional session opening data.
                  additionalProperties: true
                  example:
                    app_version: "1.2.3"
                    device_battery_level: 85
                    device_storage_available: 1024000000
                    location:
                      latitude: 59.9139
                      longitude: 10.7522
                    network_type: "wifi"
                    timestamp: "2025-02-12T16:01:37.000Z"
      responses:
        '201':
          description: Session opened successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Session opened successfully
                  session:
                    $ref: '#/components/schemas/PosSession'
        '409':
          description: Device already has an open session
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Device already has an open session
                  session:
                    $ref: '#/components/schemas/PosSession'
        '404':
          description: Store or device not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-sessions/{id}:
    get:
      tags:
        - POS Sessions
      summary: Get POS session
      description: Get a specific POS session with all details including charges
      operationId: getPosSession
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Session information
          content:
            application/json:
              schema:
                type: object
                properties:
                  session:
                    $ref: '#/components/schemas/PosSessionWithCharges'
        '404':
          description: Session not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-sessions/{id}/close:
    post:
      tags:
        - POS Sessions
      summary: Close POS session
      description: Close a POS session and automatically generate Z-report. Automatically logs events 13009 (Z-report) and 13021 (Session closed)
      operationId: closePosSession
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                actual_cash:
                  type: integer
                  nullable: true
                  description: Actual cash count in øre
                  minimum: 0
                closing_notes:
                  type: string
                  nullable: true
                  maxLength: 1000
                  description: Free-text notes for session closing (e.g., cash discrepancies, end-of-shift observations, issues encountered). Human-readable text field for cashiers/managers to document session end.
                  example: "End of shift - Cash difference: 25.00 NOK (over)"
                closing_data:
                  type: object
                  nullable: true
                  description: Additional closing data
                  additionalProperties: true
      responses:
        '200':
          description: Session closed successfully with Z-report
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Session closed successfully
                  session:
                    $ref: '#/components/schemas/PosSession'
                  report:
                    $ref: '#/components/schemas/ZReport'
        '400':
          description: Session cannot be closed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Session not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-sessions/{id}/x-report:
    post:
      tags:
        - POS Sessions
      summary: Generate X-report
      description: Generate X-report (daily sales report) for current session. Logs event 13008. Does NOT close session.
      operationId: generateXReport
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: X-report generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: X-report generated successfully
                  report:
                    $ref: '#/components/schemas/XReport'
        '404':
          description: Session not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-sessions/{id}/z-report:
    post:
      tags:
        - POS Sessions
      summary: Generate Z-report
      description: Generate Z-report (end-of-day report) and close session. Logs events 13009 and 13021.
      operationId: generateZReport
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                actual_cash:
                  type: integer
                  nullable: true
                  description: Actual cash count in øre
                  minimum: 0
                closing_notes:
                  type: string
                  nullable: true
                  maxLength: 1000
                  description: Free-text notes for session closing (e.g., cash discrepancies, end-of-shift observations, issues encountered). Human-readable text field for cashiers/managers to document session end.
                  example: "End of shift - Cash difference: 25.00 NOK (over)"
      responses:
        '200':
          description: Z-report generated and session closed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Z-report generated and session closed
                  session:
                    $ref: '#/components/schemas/PosSession'
                  report:
                    $ref: '#/components/schemas/ZReport'
        '400':
          description: Session cannot be closed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Session not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-sessions/daily-closing:
    post:
      tags:
        - POS Sessions
      summary: Create daily closing report
      description: Create a daily closing report for a specific date
      operationId: createDailyClosing
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - closing_date
              properties:
                closing_date:
                  type: string
                  format: date
                  description: Date for daily closing (YYYY-MM-DD)
                  example: "2025-11-30"
                notes:
                  type: string
                  nullable: true
                  maxLength: 1000
                  description: Closing notes
      responses:
        '201':
          description: Daily closing created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Daily closing created successfully
                  closing:
                    $ref: '#/components/schemas/PosSessionClosing'
        '409':
          description: Daily closing already exists for this date
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Daily closing already exists for this date
                  closing:
                    $ref: '#/components/schemas/PosSessionClosing'
        '404':
          description: Store not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-events:
    get:
      tags:
        - POS Events
      summary: List POS events
      description: Get paginated list of POS events (audit log) for the current store
      operationId: listPosEvents
      parameters:
        - name: event_code
          in: query
          description: Filter by event code (e.g., 13012, 13020)
          required: false
          schema:
            type: string
        - name: event_type
          in: query
          description: Filter by event type
          required: false
          schema:
            type: string
            enum: [application, user, drawer, report, transaction, payment, session, other]
        - name: pos_session_id
          in: query
          description: Filter by POS session ID
          required: false
          schema:
            type: integer
        - name: from_date
          in: query
          description: Filter from date (YYYY-MM-DD)
          required: false
          schema:
            type: string
            format: date
        - name: to_date
          in: query
          description: Filter to date (YYYY-MM-DD)
          required: false
          schema:
            type: string
            format: date
        - name: per_page
          in: query
          description: Number of items per page
          required: false
          schema:
            type: integer
            default: 50
        - name: nullinnslag
          in: query
          description: Filter by nullinnslag (drawer open without sale). Only applies to cash drawer events (13005). Use true to get only nullinnslag events, false to exclude them.
          required: false
          schema:
            type: boolean
      responses:
        '200':
          description: List of POS events
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/PosEvent'
                  pagination:
                    $ref: '#/components/schemas/PaginationMeta'
        '404':
          description: Store not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    post:
      tags:
        - POS Events
      summary: Create POS event
      description: Manually create a POS event (for events not auto-logged)
      operationId: createPosEvent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - event_code
                - event_type
              properties:
                pos_device_id:
                  type: integer
                  nullable: true
                  description: POS device ID
                pos_session_id:
                  type: integer
                  nullable: true
                  description: POS session ID
                event_code:
                  type: string
                  description: SAF-T event code (PredefinedBasicID-13)
                  example: "13012"
                event_type:
                  type: string
                  enum: [application, user, drawer, report, transaction, payment, session, other]
                  description: Event type category
                description:
                  type: string
                  nullable: true
                  maxLength: 1000
                  description: Human-readable description
                related_charge_id:
                  type: integer
                  nullable: true
                  description: Related charge ID (for transaction events)
                event_data:
                  type: object
                  nullable: true
                  description: Additional event-specific data
                  additionalProperties: true
                occurred_at:
                  type: string
                  format: date-time
                  nullable: true
                  description: When event occurred (defaults to now)
      responses:
        '201':
          description: Event created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Event created successfully
                  event:
                    $ref: '#/components/schemas/PosEvent'
        '404':
          description: Store or related resource not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-events/{id}:
    get:
      tags:
        - POS Events
      summary: Get POS event
      description: Get a specific POS event by ID
      operationId: getPosEvent
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Event information
          content:
            application/json:
              schema:
                type: object
                properties:
                  event:
                    $ref: '#/components/schemas/PosEvent'
        '404':
          description: Event not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-transactions/charges/{chargeId}/void:
    post:
      tags:
        - POS Transactions
      summary: Void transaction
      description: Void a transaction (cancel before completion). Logs event 13014.
      operationId: voidTransaction
      parameters:
        - name: chargeId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  nullable: true
                  maxLength: 500
                  description: Reason for void
                pos_session_id:
                  type: integer
                  nullable: true
                  description: POS session ID (auto-detected if not provided)
      responses:
        '200':
          description: Transaction voided successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Transaction voided successfully
                  charge:
                    type: object
                    properties:
                      id:
                        type: integer
                      stripe_charge_id:
                        type: string
                      amount:
                        type: integer
                      voided:
                        type: boolean
                        example: true
        '400':
          description: Cannot void a charge that has already been refunded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Charge not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /pos-transactions/correction-receipt:
    post:
      tags:
        - POS Transactions
      summary: Create correction receipt
      description: Create a correction receipt for errors. Logs event 13015.
      operationId: createCorrectionReceipt
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - pos_session_id
                - correction_type
                - description
              properties:
                pos_session_id:
                  type: integer
                  description: POS session ID
                related_charge_id:
                  type: integer
                  nullable: true
                  description: Related charge ID (if applicable)
                correction_type:
                  type: string
                  enum: [price_correction, item_correction, payment_correction, other]
                  description: Type of correction
                original_amount:
                  type: integer
                  nullable: true
                  description: Original amount in øre
                  minimum: 0
                corrected_amount:
                  type: integer
                  nullable: true
                  description: Corrected amount in øre
                  minimum: 0
                description:
                  type: string
                  maxLength: 1000
                  description: Description of correction
                correction_data:
                  type: object
                  nullable: true
                  description: Additional correction data
                  additionalProperties: true
      responses:
        '201':
          description: Correction receipt created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Correction receipt created successfully
                  event:
                    type: object
                    properties:
                      id:
                        type: integer
                      event_code:
                        type: string
                        example: "13015"
                      description:
                        type: string
                  receipt:
                    type: object
                    properties:
                      id:
                        type: integer
                      receipt_number:
                        type: string
                      receipt_type:
                        type: string
                        example: correction
        '404':
          description: Store or session not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /receipts:
    get:
      tags:
        - Receipts
      summary: List receipts
      description: Get paginated list of receipts for the current store
      operationId: listReceipts
      parameters:
        - name: receipt_type
          in: query
          description: Filter by receipt type
          required: false
          schema:
            type: string
            enum: [sales, return, copy, steb, provisional, training, delivery, correction]
        - name: pos_session_id
          in: query
          description: Filter by POS session ID
          required: false
          schema:
            type: integer
        - name: printed
          in: query
          description: Filter by printed status
          required: false
          schema:
            type: boolean
        - name: from_date
          in: query
          description: Filter from date (YYYY-MM-DD)
          required: false
          schema:
            type: string
            format: date
        - name: to_date
          in: query
          description: Filter to date (YYYY-MM-DD)
          required: false
          schema:
            type: string
            format: date
        - name: per_page
          in: query
          description: Number of items per page
          required: false
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of receipts
          content:
            application/json:
              schema:
                type: object
                properties:
                  receipts:
                    type: array
                    items:
                      $ref: '#/components/schemas/Receipt'
                  pagination:
                    $ref: '#/components/schemas/PaginationMeta'
        '404':
          description: Store not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /receipts/generate:
    post:
      tags:
        - Receipts
      summary: Generate receipt
      description: Generate a receipt for a charge
      operationId: generateReceipt
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - charge_id
              properties:
                charge_id:
                  type: integer
                  description: Charge ID
                receipt_type:
                  type: string
                  nullable: true
                  enum: [sales, return, copy, steb, provisional, training, delivery]
                  description: Receipt type (defaults to sales)
                pos_session_id:
                  type: integer
                  nullable: true
                  description: POS session ID (auto-detected from charge if not provided)
      responses:
        '201':
          description: Receipt generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Receipt generated successfully
                  receipt:
                    $ref: '#/components/schemas/Receipt'
        '404':
          description: Store or charge not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /receipts/{id}:
    get:
      tags:
        - Receipts
      summary: Get receipt
      description: Get a specific receipt by ID
      operationId: getReceipt
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Receipt information
          content:
            application/json:
              schema:
                type: object
                properties:
                  receipt:
                    $ref: '#/components/schemas/Receipt'
        '404':
          description: Receipt not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /receipts/{id}/xml:
    get:
      tags:
        - Receipts
      summary: Get receipt XML
      description: Get receipt in XML format (for printing)
      operationId: getReceiptXml
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Receipt XML
          content:
            application/xml:
              schema:
                type: string
        '404':
          description: Receipt not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /receipts/{id}/mark-printed:
    post:
      tags:
        - Receipts
      summary: Mark receipt as printed
      description: Mark a receipt as printed
      operationId: markReceiptPrinted
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Receipt marked as printed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Receipt marked as printed
                  receipt:
                    $ref: '#/components/schemas/Receipt'
        '404':
          description: Receipt not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /receipts/{id}/reprint:
    post:
      tags:
        - Receipts
      summary: Reprint receipt
      description: Reprint a receipt (increments reprint count)
      operationId: reprintReceipt
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Receipt reprinted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Receipt reprinted
                  receipt:
                    $ref: '#/components/schemas/Receipt'
        '404':
          description: Receipt not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /receipt-printers:
    get:
      tags:
        - Receipt Printers
      summary: List receipt printers
      description: Get all receipt printers for the current store
      operationId: listReceiptPrinters
      responses:
        '200':
          description: List of receipt printers
          content:
            application/json:
              schema:
                type: object
                properties:
                  printers:
                    type: array
                    items:
                      $ref: '#/components/schemas/ReceiptPrinter'
        '404':
          description: Store not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    post:
      tags:
        - Receipt Printers
      summary: Create receipt printer
      description: Create a new receipt printer for the current store
      operationId: createReceiptPrinter
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - printer_type
                - connection_type
              properties:
                name:
                  type: string
                  example: Main Counter Printer
                printer_type:
                  type: string
                  enum: [epson, star, generic]
                  example: epson
                printer_model:
                  type: string
                  nullable: true
                  example: TM-m30III
                paper_width:
                  type: string
                  enum: [80, 58]
                  default: '80'
                  example: '80'
                connection_type:
                  type: string
                  enum: [network, usb, bluetooth]
                  example: network
                ip_address:
                  type: string
                  format: ipv4
                  nullable: true
                  example: 192.168.1.100
                port:
                  type: integer
                  minimum: 1
                  maximum: 65535
                  default: 9100
                  example: 9100
                device_id:
                  type: string
                  nullable: true
                  default: local_printer
                  example: local_printer
                use_https:
                  type: boolean
                  default: false
                  example: false
                timeout:
                  type: integer
                  minimum: 1000
                  maximum: 300000
                  default: 60000
                  example: 60000
                is_active:
                  type: boolean
                  default: true
                  example: true
                monitor_status:
                  type: boolean
                  default: false
                  example: false
                drawer_open_level:
                  type: string
                  enum: [low, high]
                  default: low
                  example: low
                use_job_id:
                  type: boolean
                  default: false
                  example: false
                pos_device_id:
                  type: integer
                  nullable: true
                  description: Optional POS device to associate with this printer
                printer_metadata:
                  type: object
                  nullable: true
                  additionalProperties: true
      responses:
        '201':
          description: Receipt printer created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Receipt printer created successfully
                  printer:
                    $ref: '#/components/schemas/ReceiptPrinter'
        '404':
          description: Store not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /receipt-printers/{id}:
    get:
      tags:
        - Receipt Printers
      summary: Get receipt printer
      description: Get a specific receipt printer by ID
      operationId: getReceiptPrinter
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Receipt printer information
          content:
            application/json:
              schema:
                type: object
                properties:
                  printer:
                    $ref: '#/components/schemas/ReceiptPrinter'
        '404':
          description: Receipt printer not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    put:
      tags:
        - Receipt Printers
      summary: Update receipt printer
      description: Update a receipt printer
      operationId: updateReceiptPrinter
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: Main Counter Printer
                printer_type:
                  type: string
                  enum: [epson, star, generic]
                  example: epson
                printer_model:
                  type: string
                  nullable: true
                  example: TM-m30III
                paper_width:
                  type: string
                  enum: [80, 58]
                  example: '80'
                connection_type:
                  type: string
                  enum: [network, usb, bluetooth]
                  example: network
                ip_address:
                  type: string
                  format: ipv4
                  nullable: true
                  example: 192.168.1.100
                port:
                  type: integer
                  minimum: 1
                  maximum: 65535
                  example: 9100
                device_id:
                  type: string
                  nullable: true
                  example: local_printer
                use_https:
                  type: boolean
                  example: false
                timeout:
                  type: integer
                  minimum: 1000
                  maximum: 300000
                  example: 60000
                is_active:
                  type: boolean
                  example: true
                monitor_status:
                  type: boolean
                  example: false
                drawer_open_level:
                  type: string
                  enum: [low, high]
                  example: low
                use_job_id:
                  type: boolean
                  example: false
                pos_device_id:
                  type: integer
                  nullable: true
                printer_metadata:
                  type: object
                  nullable: true
                  additionalProperties: true
      responses:
        '200':
          description: Receipt printer updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Receipt printer updated successfully
                  printer:
                    $ref: '#/components/schemas/ReceiptPrinter'
        '404':
          description: Receipt printer not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    patch:
      tags:
        - Receipt Printers
      summary: Update receipt printer (partial)
      description: Partially update a receipt printer
      operationId: patchReceiptPrinter
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                printer_type:
                  type: string
                  enum: [epson, star, generic]
                printer_model:
                  type: string
                  nullable: true
                paper_width:
                  type: string
                  enum: [80, 58]
                connection_type:
                  type: string
                  enum: [network, usb, bluetooth]
                ip_address:
                  type: string
                  format: ipv4
                  nullable: true
                port:
                  type: integer
                  minimum: 1
                  maximum: 65535
                device_id:
                  type: string
                  nullable: true
                use_https:
                  type: boolean
                timeout:
                  type: integer
                  minimum: 1000
                  maximum: 300000
                is_active:
                  type: boolean
                monitor_status:
                  type: boolean
                drawer_open_level:
                  type: string
                  enum: [low, high]
                use_job_id:
                  type: boolean
                pos_device_id:
                  type: integer
                  nullable: true
                printer_metadata:
                  type: object
                  nullable: true
                  additionalProperties: true
      responses:
        '200':
          description: Receipt printer updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Receipt printer updated successfully
                  printer:
                    $ref: '#/components/schemas/ReceiptPrinter'
        '404':
          description: Receipt printer not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    delete:
      tags:
        - Receipt Printers
      summary: Delete receipt printer
      description: Delete a receipt printer
      operationId: deleteReceiptPrinter
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Receipt printer deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Receipt printer deleted successfully
        '404':
          description: Receipt printer not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /receipt-printers/{id}/test-connection:
    post:
      tags:
        - Receipt Printers
      summary: Test printer connection
      description: Test network connection to a receipt printer
      operationId: testReceiptPrinterConnection
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Connection test result
          content:
            application/json:
              schema:
                type: object
                properties:
                  connected:
                    type: boolean
                    example: true
                  printer_id:
                    type: integer
                    example: 1
                  ip_address:
                    type: string
                    example: 192.168.1.100
                  port:
                    type: integer
                    example: 9100
                  error:
                    type: string
                    nullable: true
                    example: null
        '400':
          description: Printer is not active or not a network printer
        '404':
          description: Receipt printer not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /receipt-printers/{id}/test-print:
    post:
      tags:
        - Receipt Printers
      summary: Send test print
      description: Send a test print to a receipt printer
      operationId: testReceiptPrinterPrint
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Test print result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Test print sent successfully
                  error:
                    type: string
                    nullable: true
                    example: null
        '400':
          description: Printer is not active or not a network printer
        '404':
          description: Receipt printer not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /purchases/payment-methods:
    get:
      tags:
        - Purchases
      summary: Get available payment methods
      description: Get list of enabled payment methods for the current store
      operationId: getPaymentMethods
      responses:
        '200':
          description: List of payment methods
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PaymentMethod'
        '404':
          description: Store not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /purchases:
    get:
      tags:
        - Purchases
      summary: List purchases
      description: |
        Retrieve a paginated list of purchases (charges) for the current store.
        Only purchases associated with POS sessions are returned.
      operationId: listPurchases
      parameters:
        - name: pos_session_id
          in: query
          description: Filter by POS session ID
          schema:
            type: integer
        - name: status
          in: query
          description: Filter by charge status
          schema:
            type: string
            enum: [succeeded, pending, failed, refunded]
        - name: payment_method
          in: query
          description: Filter by payment method
          schema:
            type: string
            example: cash
        - name: customer_id
          in: query
          description: Filter by customer database ID (integer)
          required: false
          schema:
            type: integer
            example: 1
        - name: from_date
          in: query
          description: Filter purchases created from this date (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: to_date
          in: query
          description: Filter purchases created until this date (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: paid_from_date
          in: query
          description: Filter purchases paid from this date (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: paid_to_date
          in: query
          description: Filter purchases paid until this date (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: search
          in: query
          description: |
            Freetext search term that searches across multiple purchase fields:
            - Purchase ID (exact match for numeric IDs)
            - Stripe charge ID
            - Description
            - Transaction code and payment code
            - Article group code
            - Customer name, email, phone, or Stripe customer ID
            - Receipt number
            - Purchase items (purchase_items) - searches in:
              * Item names, product names, descriptions
              * Product codes and article group codes
              * SKUs and barcodes
              * Item IDs (purchase_item_id)
              * Product IDs and variant IDs (if search term is numeric)
              * Product names via product relationships (from purchase_item_product_id or product_id)
              * Variant SKUs, barcodes, and option values via variant relationships (from purchase_item_variant_id or variant_id)
          required: false
          schema:
            type: string
        - name: per_page
          in: query
          description: Number of items per page (max 100)
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: List of purchases
          content:
            application/json:
              schema:
                type: object
                properties:
                  purchases:
                    type: array
                    items:
                      $ref: '#/components/schemas/Purchase'
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'
        '404':
          description: Store not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    post:
      tags:
        - Purchases
      summary: Complete purchase (single or split payment)
      description: |
        Process a complete POS purchase with single or split payment methods.
        
        **Single Payment:** Include `payment_method_code` in request body.
        **Split Payment:** Include `payments` array in request body.
        **Deferred Payment:** Set `metadata.deferred_payment` to `true` to create a purchase with payment on pickup/later.
        When using deferred payment, a delivery receipt (Utleveringskvittering) is generated per Kassasystemforskriften § 2-8-7.
        Payment can be completed later using POST /purchases/{id}/complete-payment.
        
        This endpoint:
        1. Validates the cart and payment method(s)
        2. Processes payment(s) based on method (cash, Stripe, etc.) or creates pending charge for deferred payments
        3. Creates ConnectedCharge record(s) with status 'pending' for deferred payments
        4. Generates a receipt (sales receipt for paid, delivery receipt for deferred)
        5. Logs POS events for kassasystemforskriften compliance
        6. Updates POS session totals (only for paid charges)
        7. Opens cash drawer for cash payments (not for deferred)
        8. Automatically prints receipt (if configured)
        
        For Stripe payments, the payment intent must already be created and confirmed.
        Include the payment_intent_id in the metadata.
      operationId: createPurchase
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/PurchaseSinglePaymentRequest'
                - $ref: '#/components/schemas/PurchaseSplitPaymentRequest'
      responses:
        '201':
          description: Purchase completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      charge:
                        type: object
                        properties:
                          id:
                            type: integer
                            example: 123
                          stripe_charge_id:
                            type: string
                            nullable: true
                            example: ch_xxx
                          amount:
                            type: integer
                            example: 11000
                          currency:
                            type: string
                            example: nok
                          status:
                            type: string
                            example: succeeded
                          payment_method:
                            type: string
                            example: cash
                          paid_at:
                            type: string
                            format: date-time
                            example: "2025-12-01T10:30:00Z"
                      receipt:
                        type: object
                        properties:
                          id:
                            type: integer
                            example: 456
                          receipt_number:
                            type: string
                            example: "1-S-000001"
                          receipt_type:
                            type: string
                            example: sales
                      pos_event:
                        type: object
                        properties:
                          id:
                            type: integer
                            example: 789
                          event_code:
                            type: string
                            example: "13012"
                          transaction_code:
                            type: string
                            example: "11001"
        '422':
          description: Validation error or business rule violation
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Payment method is not enabled
                  errors:
                    type: object
        '403':
          description: Unauthorized access to POS session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: POS session or payment method not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /purchases/{id}:
    get:
      tags:
        - Purchases
      summary: Get purchase
      description: Retrieve a single purchase by ID
      operationId: getPurchase
      parameters:
        - name: id
          in: path
          required: true
          description: Purchase ID
          schema:
            type: integer
      responses:
        '200':
          description: Purchase details
          content:
            application/json:
              schema:
                type: object
                properties:
                  purchase:
                    $ref: '#/components/schemas/Purchase'
        '404':
          description: Purchase not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /purchases/{id}/complete-payment:
    post:
      tags:
        - Purchases
      summary: Complete payment for deferred purchase
      description: |
        Complete payment for a purchase that was created with deferred payment (e.g., dry cleaning, payment on pickup).
        
        This endpoint:
        1. Validates the charge is pending
        2. Processes payment based on the provided payment method
        3. Updates charge status to succeeded
        4. Generates a sales receipt (replacing the delivery receipt)
        5. Logs POS events
        6. Updates POS session totals
        7. Opens cash drawer for cash payments
        8. Automatically prints receipt (if configured)
        
        For Stripe payments, the payment intent must already be created and confirmed.
        Include the payment_intent_id in the metadata.
        
        **Compliance:** This complies with Kassasystemforskriften § 2-8-7 (Utleveringskvittering).
        Deferred payments generate delivery receipts initially, then sales receipts when payment is completed.
      operationId: completePurchasePayment
      parameters:
        - name: id
          in: path
          required: true
          description: Purchase (charge) ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - payment_method_code
              properties:
                payment_method_code:
                  type: string
                  description: Code of the payment method (e.g., "cash", "card", "card_present")
                  example: cash
                pos_session_id:
                  type: integer
                  nullable: true
                  description: |
                    Optional POS session ID to use for completing the payment. 
                    If not provided, the system will:
                    1. Use the current active session for the provided pos_device_id (if pos_device_id is provided)
                    2. Fall back to the original session from when the deferred payment was created
                    This allows completing deferred payments on different devices/sessions (e.g., customer returns to a different register).
                    The session must be open and belong to the same store as the charge.
                    **Compliance:** For proper audit trail, it's recommended to provide pos_device_id to use the current active session.
                  example: 1
                pos_device_id:
                  type: integer
                  nullable: true
                  description: |
                    Optional POS device ID. If provided and pos_session_id is not provided, 
                    the system will automatically use the current active open session for this device.
                    This ensures compliance by defaulting to the session the user is currently signed in to.
                    **Compliance:** Recommended to provide this parameter to ensure proper tracking and audit trail.
                  example: 1
                metadata:
                  type: object
                  description: Payment-specific metadata (e.g., payment_intent_id for Stripe)
                  additionalProperties: true
                  example:
                    payment_intent_id: pi_xxx
      responses:
        '200':
          description: Payment completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      charge:
                        type: object
                        properties:
                          id:
                            type: integer
                            example: 123
                          stripe_charge_id:
                            type: string
                            nullable: true
                            example: ch_xxx
                          amount:
                            type: integer
                            example: 11000
                          currency:
                            type: string
                            example: nok
                          status:
                            type: string
                            example: succeeded
                          payment_method:
                            type: string
                            example: cash
                          paid_at:
                            type: string
                            format: date-time
                            example: "2025-12-09T14:30:00+01:00"
                      receipt:
                        type: object
                        properties:
                          id:
                            type: integer
                            example: 456
                          receipt_number:
                            type: string
                            example: "1-S-000001"
                          receipt_type:
                            type: string
                            example: sales
                      pos_event:
                        type: object
                        properties:
                          id:
                            type: integer
                            example: 789
                          event_code:
                            type: string
                            example: "13012"
                          transaction_code:
                            type: string
                            example: "1"
        '400':
          description: Invalid purchase ID or charge already paid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Purchase or payment method not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error or charge not pending
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                  errors:
                    type: object
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Unauthorized access to charge
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /purchases/{id}/cancel:
    post:
      tags:
        - Purchases
      summary: Cancel a pending purchase
      description: |
        Cancels a purchase that is in pending status (e.g., deferred payments).
        
        This endpoint:
        1. Validates the purchase is pending and not paid
        2. Cancels the Stripe payment intent if one exists (for deferred payments)
        3. Changes purchase status to 'cancelled'
        4. Logs a void transaction event (13014)
        5. Updates purchase metadata with cancellation information
        
        **Use cases:**
        - Cancel deferred payments that were never completed
        - Cancel pending orders that customers no longer want
        - Handle abandoned transactions
        
        **Note:** This is different from a refund. Refunds are for completed purchases.
        Cancellation is for pending purchases that never completed payment.
      operationId: cancelPurchase
      parameters:
        - name: id
          in: path
          required: true
          description: Purchase ID
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  maxLength: 500
                  description: Optional reason for cancellation
                  example: "Customer cancelled order"
      responses:
        '200':
          description: Purchase cancelled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Purchase cancelled successfully"
                  purchase:
                    $ref: '#/components/schemas/Purchase'
        '400':
          description: Invalid purchase ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Purchase not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error or purchase cannot be cancelled
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: "Purchase is not pending or already paid"
                  errors:
                    type: object
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Unauthorized access to purchase
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /purchases/{id}/refund:
    post:
      tags:
        - Purchases
      summary: Refund a purchase
      description: |
        Processes refunds for both Stripe and cash payments.
        
        **For Stripe payments:**
        - Creates a refund in Stripe
        - Updates local charge record with refund information
        - Supports full and partial refunds
        
        **For cash payments:**
        - Updates local records only (manual refund process)
        - Cash must be physically returned to customer
        
        **Automatic processes:**
        1. Validates purchase can be refunded (paid, not cancelled)
        2. Processes Stripe refund if applicable
        3. Updates charge status and refund amounts
        4. Generates return receipt automatically (Kassasystemforskriften compliance)
        5. Logs return receipt event (13013)
        6. Updates POS session totals (decrements amounts)
        7. Auto-prints receipt if configured
        
        **Compliance:**
        - Return receipts are immutable and sequentially numbered
        - All refunds are logged in POS events for audit trail
        - Supports refund reasons for compliance tracking
        
        **Use cases:**
        - Full refunds for returned items
        - Partial refunds for partial returns
        - Refunds with reasons for compliance tracking
      operationId: refundPurchase
      parameters:
        - name: id
          in: path
          required: true
          description: Purchase ID
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                amount:
                  type: integer
                  minimum: 1
                  description: |
                    Amount to refund in minor units (øre).
                    If not provided, refunds the full remaining refundable amount.
                    Must not exceed remaining refundable amount.
                  example: 5000
                reason:
                  type: string
                  maxLength: 500
                  description: Optional reason for refund (for compliance tracking)
                  example: "Customer returned item"
                pos_device_id:
                  type: integer
                  description: |
                    Optional: Current POS device ID (if you want to specify which device's session to use).
                    If not provided and original session is closed, backend auto-detects current open session.
                    For compliance: Refunds from closed sessions are tracked in the current open session.
                    The original session totals remain unchanged per Kassasystemforskriften.
                  example: 5
                pos_session_id:
                  type: integer
                  description: |
                    Optional: Current POS session ID (if you want to specify which session to use).
                    Must be an open session. If not provided and original session is closed, backend auto-detects.
                  example: 123
                items:
                  type: array
                  description: Optional array of items being refunded (for item-level tracking)
                  items:
                    type: object
                    properties:
                      item_id:
                        type: string
                        description: Purchase item ID
                      quantity:
                        type: integer
                        description: Quantity to refund
      responses:
        '200':
          description: Refund processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Refund processed successfully"
                  data:
                    type: object
                    properties:
                      charge:
                        type: object
                        properties:
                          id:
                            type: integer
                            example: 123
                          stripe_charge_id:
                            type: string
                            nullable: true
                            example: "ch_1234567890"
                          amount:
                            type: integer
                            description: Original purchase amount in minor units (øre)
                            example: 10000
                          amount_refunded:
                            type: integer
                            description: Total amount refunded so far in minor units (øre)
                            example: 5000
                          currency:
                            type: string
                            example: "nok"
                          status:
                            type: string
                            enum: [succeeded, pending, failed, refunded, cancelled]
                            description: Purchase status (will be 'refunded' if fully refunded)
                            example: "succeeded"
                          refunded:
                            type: boolean
                            description: Whether purchase is fully refunded
                            example: false
                          payment_method:
                            type: string
                            example: "card"
                      receipt:
                        type: object
                        properties:
                          id:
                            type: integer
                            example: 456
                          receipt_number:
                            type: string
                            description: Sequential receipt number
                            example: "RET-2025-000123"
                          receipt_type:
                            type: string
                            example: "return"
                      pos_event:
                        type: object
                        properties:
                          id:
                            type: integer
                            example: 789
                          event_code:
                            type: string
                            description: POS event code (13013 for return receipt)
                            example: "13013"
                          description:
                            type: string
                            example: "Return receipt for charge ch_1234567890"
        '400':
          description: Invalid purchase ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Purchase not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error or purchase cannot be refunded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: "Cannot refund a purchase that has not been paid"
                  errors:
                    type: object
        '500':
          description: Refund processing failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: "Refund processing failed: Stripe refund failed: ..."
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Unauthorized access to purchase
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /purchases/{id}/customer:
    put:
      tags:
        - Purchases
      summary: Register or update customer for purchase
      description: |
        Register a customer to an existing purchase, or remove the customer by setting customer_id to null.
        This allows associating a customer with a purchase after it has been completed.
      operationId: updatePurchaseCustomer
      parameters:
        - name: id
          in: path
          required: true
          description: Purchase ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                customer_id:
                  type: integer
                  nullable: true
                  description: Customer database ID (integer). Set to null to remove customer from purchase.
                  example: 1
      responses:
        '200':
          description: Customer updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Customer registered to purchase successfully"
                  purchase:
                    $ref: '#/components/schemas/Purchase'
        '400':
          description: Invalid purchase ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Purchase or customer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                  errors:
                    type: object
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    patch:
      tags:
        - Purchases
      summary: Register or update customer for purchase (PATCH)
      description: Same as PUT /purchases/{id}/customer
      operationId: updatePurchaseCustomerPatch
      parameters:
        - name: id
          in: path
          required: true
          description: Purchase ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                customer_id:
                  type: integer
                  nullable: true
                  description: Customer database ID (integer). Set to null to remove customer from purchase.
                  example: 1
      responses:
        '200':
          description: Customer updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Customer registered to purchase successfully"
                  purchase:
                    $ref: '#/components/schemas/Purchase'
        '400':
          description: Invalid purchase ID
        '404':
          description: Purchase or customer not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /products:
    get:
      tags:
        - Products
      summary: List products
      description: Get paginated list of active products for POS
      operationId: listProducts
      parameters:
        - name: search
          in: query
          description: |
            Freetext search term that searches across multiple product fields:
            - Product name, description
            - Product codes (product_code, article_group_code)
            - Stripe product ID
            - Variant SKU and barcode
            - Variant names and option values
            - Stripe product/price IDs for variants
          required: false
          schema:
            type: string
        - name: type
          in: query
          description: Filter by product type
          required: false
          schema:
            type: string
        - name: collection_id
          in: query
          description: Filter by collection ID. Use 0 to get uncategorized products (products with no collection)
          required: false
          schema:
            type: integer
            example: 1
        - name: collection_slug
          in: query
          description: Filter by collection slug/handle
          required: false
          schema:
            type: string
            example: summer-collection
        - name: per_page
          in: query
          description: Number of items per page (max 100)
          required: false
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: List of products
          content:
            application/json:
              schema:
                type: object
                properties:
                  product:
                    type: array
                    items:
                      $ref: '#/components/schemas/Product'
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'
        '404':
          description: Store not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /products/{id}:
    get:
      tags:
        - Products
      summary: Get product
      description: Get a specific product with variants and inventory
      operationId: getProduct
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Product information
          content:
            application/json:
              schema:
                type: object
                properties:
                  product:
                    $ref: '#/components/schemas/Product'
        '404':
          description: Product not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /products/{product}/images/{media}:
    get:
      tags:
        - Products
      summary: Serve product image
      description: Serve product image with signed URL (public endpoint, secured by signature)
      operationId: serveProductImage
      security: []
      parameters:
        - name: product
          in: path
          required: true
          schema:
            type: integer
        - name: media
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Product image
          content:
            image/*:
              schema:
                type: string
                format: binary
        '404':
          description: Product or image not found
        '403':
          description: Invalid signature

  /products/{product}/inventory:
    get:
      tags:
        - Inventory
      summary: Get product inventory
      description: Get inventory information for a product and all its variants
      operationId: getProductInventory
      parameters:
        - name: product
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Product inventory information
          content:
            application/json:
              schema:
                type: object
                properties:
                  product_id:
                    type: integer
                  tracked:
                    type: boolean
                  total_quantity:
                    type: integer
                    nullable: true
                  in_stock_variants:
                    type: integer
                  out_of_stock_variants:
                    type: integer
                  all_in_stock:
                    type: boolean
                    nullable: true
                  variants:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        sku:
                          type: string
                          nullable: true
                        inventory:
                          type: object
                          properties:
                            quantity:
                              type: integer
                              nullable: true
                            in_stock:
                              type: boolean
                            policy:
                              type: string
                              nullable: true
                            tracked:
                              type: boolean
        '404':
          description: Product not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /collections:
    get:
      tags:
        - Collections
      summary: List collections
      description: 'Get paginated list of collections. If there are products with no collection, a fake "Ukategorisert" category with id 0 will be included in the list.'
      operationId: listCollections
      parameters:
        - name: search
          in: query
          description: Search term (name or description)
          required: false
          schema:
            type: string
        - name: active
          in: query
          description: Filter by active status (defaults to true)
          required: false
          schema:
            type: boolean
        - name: per_page
          in: query
          description: Number of items per page (max 100)
          required: false
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: List of collections
          content:
            application/json:
              schema:
                type: object
                properties:
                  collections:
                    type: array
                    items:
                      $ref: '#/components/schemas/Collection'
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'
        '404':
          description: Store not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /collections/{id}:
    get:
      tags:
        - Collections
      summary: Get collection
      description: Get a specific collection with its products
      operationId: getCollection
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Collection information with products
          content:
            application/json:
              schema:
                type: object
                properties:
                  collection:
                    allOf:
                      - $ref: '#/components/schemas/Collection'
                      - type: object
                        properties:
                          products:
                            type: array
                            items:
                              $ref: '#/components/schemas/Product'
        '404':
          description: Collection not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /variants/{variant}/inventory:
    put:
      tags:
        - Inventory
      summary: Update variant inventory
      description: Update inventory settings for a product variant
      operationId: updateVariantInventory
      parameters:
        - name: variant
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                inventory_quantity:
                  type: integer
                  nullable: true
                  minimum: 0
                  description: Inventory quantity
                inventory_policy:
                  type: string
                  nullable: true
                  enum: [deny, continue]
                  description: Inventory policy
                inventory_management:
                  type: string
                  nullable: true
                  maxLength: 255
                  description: Inventory management system
      responses:
        '200':
          description: Variant inventory updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  variant:
                    type: object
                    properties:
                      id:
                        type: integer
                      sku:
                        type: string
                        nullable: true
                      variant_inventory:
                        type: object
                        properties:
                          quantity:
                            type: integer
                            nullable: true
                          in_stock:
                            type: boolean
                          policy:
                            type: string
                            nullable: true
                          management:
                            type: string
                            nullable: true
                          tracked:
                            type: boolean
        '404':
          description: Variant not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /variants/{variant}/inventory/adjust:
    post:
      tags:
        - Inventory
      summary: Adjust inventory
      description: Add or subtract from inventory quantity
      operationId: adjustInventory
      parameters:
        - name: variant
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - quantity
              properties:
                quantity:
                  type: integer
                  description: Amount to adjust (positive to add, negative to subtract)
                  example: -5
                reason:
                  type: string
                  nullable: true
                  maxLength: 255
                  description: Reason for adjustment
                note:
                  type: string
                  nullable: true
                  maxLength: 1000
                  description: Additional notes
      responses:
        '200':
          description: Inventory adjusted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Inventory adjusted successfully
                  variant:
                    type: object
                    properties:
                      id:
                        type: integer
                      inventory_quantity:
                        type: integer
                        nullable: true
        '404':
          description: Variant not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /variants/{variant}/inventory/set:
    post:
      tags:
        - Inventory
      summary: Set inventory quantity
      description: Set inventory quantity to a specific value
      operationId: setInventory
      parameters:
        - name: variant
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - quantity
              properties:
                quantity:
                  type: integer
                  minimum: 0
                  description: New inventory quantity
                  example: 100
                reason:
                  type: string
                  nullable: true
                  maxLength: 255
                  description: Reason for setting quantity
      responses:
        '200':
          description: Inventory quantity set successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Inventory quantity set successfully
                  variant:
                    type: object
                    properties:
                      id:
                        type: integer
                      inventory_quantity:
                        type: integer
                        nullable: true
        '404':
          description: Variant not found
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /inventory/bulk-update:
    post:
      tags:
        - Inventory
      summary: Bulk update inventory
      description: Update inventory for multiple variants at once
      operationId: bulkUpdateInventory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - updates
              properties:
                updates:
                  type: array
                  description: Array of inventory updates
                  items:
                    type: object
                    required:
                      - variant_id
                    properties:
                      variant_id:
                        type: integer
                        description: Variant ID
                      inventory_quantity:
                        type: integer
                        nullable: true
                        minimum: 0
                      inventory_policy:
                        type: string
                        nullable: true
                        enum: [deny, continue]
                      inventory_management:
                        type: string
                        nullable: true
                        maxLength: 255
      responses:
        '200':
          description: Bulk update completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Bulk update completed
                  updated:
                    type: integer
                    description: Number of variants updated
                  failed:
                    type: integer
                    description: Number of variants that failed to update
        '422':
          description: Validation error
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /saf-t/generate:
    post:
      tags:
        - SAF-T
      summary: Generate SAF-T file
      description: Generate and store a SAF-T Cash Register file for a date range
      operationId: generateSafT
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - from_date
                - to_date
              properties:
                from_date:
                  type: string
                  format: date
                  description: Start date (YYYY-MM-DD)
                  example: "2025-11-01"
                to_date:
                  type: string
                  format: date
                  description: End date (YYYY-MM-DD, must be >= from_date)
                  example: "2025-11-30"
      responses:
        '201':
          description: SAF-T file generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: SAF-T file generated successfully
                  filename:
                    type: string
                    example: SAF-T_store-slug_2025-11-01_2025-11-30.xml
                  download_url:
                    type: string
                    format: uri
                    example: https://pos.visivo.no/api/saf-t/download/SAF-T_store-slug_2025-11-01_2025-11-30.xml
                  size:
                    type: integer
                    description: File size in bytes
                  from_date:
                    type: string
                    format: date
                  to_date:
                    type: string
                    format: date
        '404':
          description: Store not found
        '422':
          description: Validation error
        '500':
          description: Failed to generate SAF-T file
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /saf-t/content:
    get:
      tags:
        - SAF-T
      summary: Get SAF-T XML content
      description: Get SAF-T XML content directly (returns XML file)
      operationId: getSafTContent
      parameters:
        - name: from_date
          in: query
          required: true
          description: Start date (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: to_date
          in: query
          required: true
          description: End date (YYYY-MM-DD)
          schema:
            type: string
            format: date
      responses:
        '200':
          description: SAF-T XML content
          content:
            application/xml:
              schema:
                type: string
          headers:
            Content-Disposition:
              description: Attachment filename
              schema:
                type: string
        '404':
          description: Store not found
        '422':
          description: Validation error
        '500':
          description: Failed to generate SAF-T file
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /saf-t/download/{filename}:
    get:
      tags:
        - SAF-T
      summary: Download SAF-T file
      description: Download a previously generated SAF-T file
      operationId: downloadSafT
      parameters:
        - name: filename
          in: path
          required: true
          schema:
            type: string
          example: SAF-T_store-slug_2025-11-01_2025-11-30.xml
      responses:
        '200':
          description: SAF-T XML file download
          content:
            application/xml:
              schema:
                type: string
                format: binary
        '403':
          description: Unauthorized access to this file
        '404':
          description: File not found
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /terminals/locations:
    get:
      tags:
        - Terminals
      summary: List terminal locations
      description: Get all terminal locations for the current store
      operationId: listTerminalLocations
      responses:
        '200':
          description: List of terminal locations
          content:
            application/json:
              schema:
                type: object
                properties:
                  locations:
                    type: array
                    items:
                      $ref: '#/components/schemas/TerminalLocation'
        '404':
          description: Store not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /terminals/readers:
    get:
      tags:
        - Terminals
      summary: List terminal readers
      description: Get all terminal readers for the current store
      operationId: listTerminalReaders
      responses:
        '200':
          description: List of terminal readers
          content:
            application/json:
              schema:
                type: object
                properties:
                  readers:
                    type: array
                    items:
                      $ref: '#/components/schemas/TerminalReader'
        '404':
          description: Store not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /customers:
    get:
      tags:
        - Customers
      summary: List customers
      description: Get paginated list of customers for the current store
      operationId: listCustomers
      parameters:
        - name: per_page
          in: query
          description: Number of items per page
          required: false
          schema:
            type: integer
            default: 15
        - name: X-Tenant
          in: header
          description: Store slug (optional, defaults to user's first store)
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Paginated list of customers
          content:
            application/json:
              schema:
                type: object
                properties:
                  customers:
                    type: array
                    items:
                      $ref: '#/components/schemas/Customer'
                  current_page:
                    type: integer
                    example: 1
                  last_page:
                    type: integer
                    example: 10
                  per_page:
                    type: integer
                    example: 15
                  total:
                    type: integer
                    example: 100
        '404':
          description: Store not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    post:
      tags:
        - Customers
      summary: Create customer
      description: Create a new customer for the current store. The Stripe customer will be created automatically after the local customer is created.
      operationId: createCustomer
      parameters:
        - name: X-Tenant
          in: header
          description: Store slug (optional, defaults to user's first store)
          required: false
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  maxLength: 255
                  example: John Doe
                email:
                  type: string
                  format: email
                  maxLength: 255
                  example: john@example.com
                phone:
                  type: string
                  nullable: true
                  description: Customer phone number (per Stripe API spec)
                  example: "+4712345678"
                profile_image_url:
                  type: string
                  format: uri
                  nullable: true
                  description: URL to the customer profile image
                  example: "https://example.com/images/profile.jpg"
                customer_address:
                  type: object
                  nullable: true
                  description: Customer address (per Stripe API spec)
                  properties:
                    line1:
                      type: string
                      nullable: true
                      description: Address line 1 (street, PO Box, or company name)
                      example: "123 Main St"
                    line2:
                      type: string
                      nullable: true
                      description: Address line 2 (apartment, suite, unit, or building)
                      example: "Apt 4B"
                    city:
                      type: string
                      nullable: true
                      description: City, district, suburb, town, or village
                      example: "Oslo"
                    state:
                      type: string
                      nullable: true
                      description: State, county, province, or region
                      example: "Oslo"
                    postal_code:
                      type: string
                      nullable: true
                      description: ZIP or postal code
                      example: "0001"
                    country:
                      type: string
                      nullable: true
                      description: Two-letter country code (ISO 3166-1 alpha-2)
                      example: "NO"
      responses:
        '201':
          description: Customer created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'
        '404':
          description: Store not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /customers/{id}:
    get:
      tags:
        - Customers
      summary: Get customer
      description: Get a specific customer by ID
      operationId: getCustomer
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          example: 1
        - name: X-Tenant
          in: header
          description: Store slug (optional, defaults to user's first store)
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Customer information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'
        '404':
          description: Customer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    put:
      tags:
        - Customers
      summary: Update customer
      description: Update a customer's information
      operationId: updateCustomer
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          example: 1
        - name: X-Tenant
          in: header
          description: Store slug (optional, defaults to user's first store)
          required: false
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  maxLength: 255
                  example: John Doe
                email:
                  type: string
                  format: email
                  maxLength: 255
                  example: john@example.com
                phone:
                  type: string
                  nullable: true
                  description: Customer phone number (per Stripe API spec)
                  example: "+4712345678"
                profile_image_url:
                  type: string
                  format: uri
                  nullable: true
                  description: URL to the customer profile image
                  example: "https://example.com/images/profile.jpg"
                customer_address:
                  type: object
                  nullable: true
                  description: Customer address (per Stripe API spec)
                  properties:
                    line1:
                      type: string
                      nullable: true
                      description: Address line 1 (street, PO Box, or company name)
                      example: "123 Main St"
                    line2:
                      type: string
                      nullable: true
                      description: Address line 2 (apartment, suite, unit, or building)
                      example: "Apt 4B"
                    city:
                      type: string
                      nullable: true
                      description: City, district, suburb, town, or village
                      example: "Oslo"
                    state:
                      type: string
                      nullable: true
                      description: State, county, province, or region
                      example: "Oslo"
                    postal_code:
                      type: string
                      nullable: true
                      description: ZIP or postal code
                      example: "0001"
                    country:
                      type: string
                      nullable: true
                      description: Two-letter country code (ISO 3166-1 alpha-2)
                      example: "NO"
                model:
                  type: string
                  nullable: true
                model_id:
                  type: integer
                  nullable: true
                model_uuid:
                  type: string
                  format: uuid
                  nullable: true
      responses:
        '200':
          description: Customer updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'
        '404':
          description: Customer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    delete:
      tags:
        - Customers
      summary: Delete customer
      description: Delete a customer
      operationId: deleteCustomer
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          example: 1
        - name: X-Tenant
          in: header
          description: Store slug (optional, defaults to user's first store)
          required: false
          schema:
            type: string
      responses:
        '204':
          description: Customer deleted successfully
        '404':
          description: Customer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /stores/{store}/terminal/connection-token:
    post:
      tags:
        - Terminals
      summary: Create terminal connection token
      description: Create a connection token for Stripe Terminal
      operationId: createTerminalConnectionToken
      parameters:
        - name: store
          in: path
          required: true
          description: Store ID or slug
          schema:
            type: string
          example: 1
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                location_id:
                  type: integer
                  description: Terminal location ID (optional if store has only one location)
                  example: 1
      responses:
        '200':
          description: Connection token created
          content:
            application/json:
              schema:
                type: object
                properties:
                  secret:
                    type: string
                    example: pst_test_1234567890
        '404':
          description: Store or location not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /stores/{store}/terminal/payment-intents:
    post:
      tags:
        - Terminals
      summary: Create payment intent
      description: Create a payment intent for Stripe Terminal
      operationId: createTerminalPaymentIntent
      parameters:
        - name: store
          in: path
          required: true
          description: Store ID or slug
          schema:
            type: string
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
              properties:
                amount:
                  type: integer
                  description: Amount in minor units (cents)
                  minimum: 1
                  example: 1000
                currency:
                  type: string
                  description: Currency code (ISO 3-letter)
                  minLength: 3
                  maxLength: 3
                  example: usd
                description:
                  type: string
                  maxLength: 255
                  example: Payment for order #123
                metadata:
                  type: object
                  additionalProperties: true
                  example:
                    order_id: "123"
                    customer_name: "John Doe"
      responses:
        '201':
          description: Payment intent created
          content:
            application/json:
              schema:
                type: object
                description: Stripe PaymentIntent object
                properties:
                  id:
                    type: string
                    example: pi_1234567890
                  amount:
                    type: integer
                    example: 1000
                  currency:
                    type: string
                    example: usd
                  status:
                    type: string
                    example: requires_payment_method
        '422':
          description: Validation error or store not connected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /stripe/connect/webhook:
    post:
      tags:
        - Webhooks
      summary: Stripe Connect webhook
      description: |
        Webhook endpoint for Stripe Connect events.

        This endpoint receives webhooks from Stripe for connected account events.
        It handles events such as:
        - account.created, account.updated, account.deleted
        - customer.created, customer.updated, customer.deleted
        - charge.created, charge.updated, charge.refunded
        - subscription events
        - product and price events
        - payment method events
        - transfer events

        **Note:** This endpoint does not require authentication as it uses Stripe signature verification.
      operationId: stripeConnectWebhook
      security: []  # Public endpoint - uses Stripe signature verification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Stripe webhook event payload
      responses:
        '200':
          description: Webhook processed successfully
        '400':
          description: Invalid payload or signature
        '500':
          description: Server error

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Sanctum Bearer Token authentication.

        Include the token in the Authorization header:
        ```
        Authorization: Bearer {token}
        ```

        Get a token by calling the `/auth/login` endpoint.

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: John Doe
        email:
          type: string
          format: email
          example: user@example.com

    Store:
      type: object
      properties:
        id:
          type: integer
          example: 1
        slug:
          type: string
          example: my-store
        name:
          type: string
          example: My Store
        email:
          type: string
          format: email
          example: store@example.com
        stripe_account_id:
          type: string
          nullable: true
          example: acct_1234567890
        commission_type:
          type: string
          enum: [percentage, fixed]
          example: percentage
        commission_rate:
          type: integer
          example: 10

    Customer:
      type: object
      properties:
        id:
          type: integer
          example: 1
        stripe_customer_id:
          type: string
          example: cus_1234567890
        stripe_account_id:
          type: string
          example: acct_1234567890
        name:
          type: string
          nullable: true
          example: John Doe
        email:
          type: string
          format: email
          nullable: true
          example: john@example.com
        phone:
          type: string
          nullable: true
          description: Customer phone number (per Stripe API spec)
          example: "+4712345678"
        profile_image_url:
          type: string
          format: uri
          nullable: true
          description: URL to the customer profile image
          example: "https://example.com/images/profile.jpg"
        customer_address:
          type: object
          nullable: true
          description: Customer address (per Stripe API spec)
          properties:
            line1:
              type: string
              nullable: true
              description: Address line 1 (street, PO Box, or company name)
              example: "123 Main St"
            line2:
              type: string
              nullable: true
              description: Address line 2 (apartment, suite, unit, or building)
              example: "Apt 4B"
            city:
              type: string
              nullable: true
              description: City, district, suburb, town, or village
              example: "Oslo"
            state:
              type: string
              nullable: true
              description: State, county, province, or region
              example: "Oslo"
            postal_code:
              type: string
              nullable: true
              description: ZIP or postal code
              example: "0001"
            country:
              type: string
              nullable: true
              description: Two-letter country code (ISO 3166-1 alpha-2)
              example: "NO"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    TerminalLocation:
      type: object
      properties:
        id:
          type: integer
          example: 1
        stripe_location_id:
          type: string
          nullable: true
          example: tml_1234567890
        display_name:
          type: string
          example: Main Store Location
        address:
          type: object
          properties:
            line1:
              type: string
              nullable: true
              example: 123 Main St
            line2:
              type: string
              nullable: true
              example: Suite 100
            city:
              type: string
              nullable: true
              example: Oslo
            state:
              type: string
              nullable: true
              example: Oslo
            postal_code:
              type: string
              nullable: true
              example: 0001
            country:
              type: string
              nullable: true
              example: NO
        readers_count:
          type: integer
          example: 3
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    TerminalReader:
      type: object
      properties:
        id:
          type: integer
          example: 1
        stripe_reader_id:
          type: string
          nullable: true
          example: tmr_1234567890
        label:
          type: string
          example: Counter Reader 1
        tap_to_pay:
          type: boolean
          example: false
        device_type:
          type: string
          nullable: true
          example: verifone_P400
        status:
          type: string
          nullable: true
          example: online
        location:
          type: object
          nullable: true
          properties:
            id:
              type: integer
              example: 1
            display_name:
              type: string
              example: Main Store Location
            stripe_location_id:
              type: string
              example: tml_1234567890
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    PosDevice:
      type: object
      properties:
        id:
          type: integer
          example: 1
        device_identifier:
          type: string
          description: "Unique device identifier (iOS: identifierForVendor, Android: androidId)"
          example: ABC123-DEF456-GHI789
        device_name:
          type: string
          example: Jan's iPad
        platform:
          type: string
          enum: [ios, android]
          example: ios
        device_info:
          type: object
          properties:
            model:
              type: string
              nullable: true
              example: iPad
            brand:
              type: string
              nullable: true
              example: Apple
            manufacturer:
              type: string
              nullable: true
              example: Apple
            product:
              type: string
              nullable: true
            hardware:
              type: string
              nullable: true
            machine_identifier:
              type: string
              nullable: true
              example: "iPad13,1"
        system_info:
          type: object
          properties:
            name:
              type: string
              nullable: true
              example: iOS
            version:
              type: string
              nullable: true
              example: 17.0
        identifiers:
          type: object
          properties:
            vendor_identifier:
              type: string
              nullable: true
            android_id:
              type: string
              nullable: true
            serial_number:
              type: string
              nullable: true
        device_status:
          type: string
          enum: [active, inactive, maintenance, offline]
          example: active
        last_seen_at:
          type: string
          format: date-time
          nullable: true
        device_metadata:
          type: object
          nullable: true
          description: Additional device metadata
          additionalProperties: true
        terminal_locations_count:
          type: integer
          example: 1
        terminal_locations:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              display_name:
                type: string
              stripe_location_id:
                type: string
                nullable: true
              readers_count:
                type: integer
        receipt_printers_count:
          type: integer
          example: 1
          description: Number of receipt printers attached to this device
        default_printer_id:
          type: integer
          nullable: true
          example: 1
          description: ID of the default receipt printer for this POS device (set via Filament admin)
        receipt_printers:
          type: array
          description: List of receipt printers attached to this POS device
          items:
            type: object
            properties:
              id:
                type: integer
                example: 1
              name:
                type: string
                example: Main Counter Printer
              printer_type:
                type: string
                enum: [epson, star, generic]
                example: epson
              printer_model:
                type: string
                nullable: true
                example: TM-m30III
              connection_type:
                type: string
                enum: [network, usb, bluetooth]
                example: network
              ip_address:
                type: string
                format: ipv4
                nullable: true
                example: 192.168.1.100
              port:
                type: integer
                example: 9100
              is_active:
                type: boolean
                example: true
              epos_url:
                type: string
                nullable: true
                description: ePOS-Print service URL (for network printers)
                example: http://192.168.1.100/cgi-bin/epos/service.cgi?devid=local_printer&timeout=60000
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    LoginResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/User'
        token:
          type: string
          description: Bearer token for API authentication
          example: 1|abc123def456...
        current_store:
          description: User's current/default store
          allOf:
            - $ref: '#/components/schemas/Store'
            - type: object
              nullable: true
        stores:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/Store'
              - type: object
                properties:
                  is_current:
                    type: boolean
                    description: Whether this is the user's current store
                    example: true

    UserResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/User'
        current_store:
          description: User's current/default store
          allOf:
            - $ref: '#/components/schemas/Store'
            - type: object
              nullable: true
        stores:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/Store'
              - type: object
                properties:
                  is_current:
                    type: boolean
                    description: Whether this is the user's current store
                    example: true

    PaginationMeta:
      type: object
      properties:
        current_page:
          type: integer
          example: 1
        last_page:
          type: integer
          example: 10
        per_page:
          type: integer
          example: 20
        total:
          type: integer
          example: 200

    Purchase:
      type: object
      description: Purchase (charge) with purchase_ prefixed nested structures for FlutterFlow
      properties:
        id:
          type: integer
          example: 123
        stripe_charge_id:
          type: string
          nullable: true
          example: "ch_1234567890abcdef"
        amount:
          type: integer
          description: Amount in øre
          example: 11000
        amount_refunded:
          type: integer
          description: Amount refunded in øre
          example: 0
        currency:
          type: string
          example: "nok"
        status:
          type: string
          enum: [succeeded, pending, failed, refunded, cancelled]
          example: "succeeded"
        payment_method:
          type: string
          example: "cash"
        description:
          type: string
          nullable: true
          example: "POS Purchase"
        failure_code:
          type: string
          nullable: true
        failure_message:
          type: string
          nullable: true
        captured:
          type: boolean
          example: true
        refunded:
          type: boolean
          example: false
        paid:
          type: boolean
          example: true
        paid_at:
          type: string
          format: date-time
          nullable: true
          example: "2025-12-01T10:30:00+01:00"
        charge_type:
          type: string
          nullable: true
          example: "pos"
        application_fee_amount:
          type: integer
          nullable: true
          description: Application fee in øre
        tip_amount:
          type: integer
          nullable: true
          description: Tip amount in øre
          example: 500
        transaction_code:
          type: string
          nullable: true
          description: SAF-T transaction code (PredefinedBasicID-11)
          example: "11001"
        payment_code:
          type: string
          nullable: true
          description: SAF-T payment code (PredefinedBasicID-12)
          example: "12001"
        article_group_code:
          type: string
          nullable: true
          description: SAF-T article group code (PredefinedBasicID-04)
          example: "04001"
        purchase_metadata:
          type: object
          nullable: true
          description: Additional metadata (cashier_name, device_id, payment_intent_id, etc.)
          additionalProperties: true
          example:
            cashier_name: "John Doe"
            device_id: 1
            payment_intent_id: "pi_xxx"
        outcome:
          type: object
          nullable: true
          description: Payment outcome (for Stripe payments)
          additionalProperties: true
        created_at:
          type: string
          format: date-time
          example: "2025-12-01T10:30:00+01:00"
        updated_at:
          type: string
          format: date-time
          example: "2025-12-01T10:30:00+01:00"
        purchase_session:
          type: object
          nullable: true
          description: POS session information
          properties:
            id:
              type: integer
              example: 45
            session_number:
              type: string
              example: "000001"
            status:
              type: string
              enum: [open, closed, abandoned]
              example: "open"
            opened_at:
              type: string
              format: date-time
              nullable: true
              example: "2025-12-01T08:00:00+01:00"
            closed_at:
              type: string
              format: date-time
              nullable: true
        purchase_store:
          type: object
          nullable: true
          description: Store information
          properties:
            id:
              type: integer
              example: 1
            name:
              type: string
              example: "My Store"
            slug:
              type: string
              example: "my-store"
        purchase_receipt:
          type: object
          nullable: true
          description: Receipt information
          properties:
            id:
              type: integer
              example: 789
            receipt_number:
              type: string
              example: "1-S-000001"
            receipt_type:
              type: string
              example: "sales"
            printed:
              type: boolean
              example: true
            printed_at:
              type: string
              format: date-time
              nullable: true
              example: "2025-12-01T10:30:05+01:00"
            reprint_count:
              type: integer
              example: 0
        purchase_customer:
          type: object
          description: Customer information (always present, null values if no customer). Matches the Customer schema from /customers API.
          properties:
            id:
              type: integer
              nullable: true
              example: 10
            stripe_customer_id:
              type: string
              nullable: true
              example: "cus_xxx"
            stripe_account_id:
              type: string
              nullable: true
              example: "acct_1234567890"
            name:
              type: string
              nullable: true
              example: "Customer Name"
            email:
              type: string
              format: email
              nullable: true
              example: "customer@example.com"
            phone:
              type: string
              nullable: true
              description: Customer phone number (per Stripe API spec)
              example: "+4712345678"
            profile_image_url:
              type: string
              format: uri
              nullable: true
              description: URL to the customer profile image
              example: "https://example.com/images/profile.jpg"
            customer_address:
              type: object
              nullable: true
              description: Customer address (per Stripe API spec)
              properties:
                line1:
                  type: string
                  nullable: true
                  description: Address line 1 (street, PO Box, or company name)
                  example: "123 Main St"
                line2:
                  type: string
                  nullable: true
                  description: Address line 2 (apartment, suite, unit, or building)
                  example: "Apt 4B"
                city:
                  type: string
                  nullable: true
                  description: City, district, suburb, town, or village
                  example: "Oslo"
                state:
                  type: string
                  nullable: true
                  description: State, county, province, or region
                  example: "Oslo"
                postal_code:
                  type: string
                  nullable: true
                  description: ZIP or postal code
                  example: "0001"
                country:
                  type: string
                  nullable: true
                  description: Two-letter country code (ISO 3166-1 alpha-2)
                  example: "NO"
            created_at:
              type: string
              format: date-time
              nullable: true
              example: "2025-11-28T13:59:53.000000Z"
            updated_at:
              type: string
              format: date-time
              nullable: true
              example: "2025-12-09T14:02:52.000000Z"
        purchase_items:
          type: array
          nullable: true
          description: Array of purchased items/products with enriched product information
          items:
            type: object
            properties:
              purchase_item_id:
                type: string
                nullable: true
                description: Cart item ID (UUID from FlutterFlow)
                example: "550e8400-e29b-41d4-a716-446655440000"
              purchase_item_product_id:
                type: string
                nullable: true
                description: Product ID
                example: "123"
              purchase_item_variant_id:
                type: string
                nullable: true
                description: Product variant ID (if applicable)
                example: "456"
              purchase_item_product_name:
                type: string
                nullable: true
                description: Product name (includes variant name if applicable)
                example: "Coffee - Large"
              purchase_item_description:
                type: string
                nullable: true
                description: Custom description for diverse products or products without price. This is used on receipts instead of product_name when provided.
                example: "Various items - customer selection"
              purchase_item_product_image_url:
                type: string
                nullable: true
                description: Product image URL (signed URL for security)
                format: uri
                example: "https://pos.visivo.no/api/products/123/images/789?signature=..."
              purchase_item_unit_price:
                type: integer
                description: Price per unit in øre
                example: 5000
              purchase_item_quantity:
                type: integer
                description: Quantity purchased
                example: 2
              purchase_item_original_price:
                type: integer
                nullable: true
                description: Original price before discount in øre
                example: 5500
              purchase_item_discount_amount:
                type: integer
                nullable: true
                description: Discount amount per unit in øre
                example: 500
              purchase_item_discount_reason:
                type: string
                nullable: true
                description: Reason for discount
                example: "Manager override"
              purchase_item_article_group_code:
                type: string
                nullable: true
                description: SAF-T article group code (PredefinedBasicID-04)
                example: "04001"
              purchase_item_product_code:
                type: string
                nullable: true
                description: SAF-T product code (PLU - BasicType-02)
                example: "COFFEE001"
              purchase_item_metadata:
                type: object
                nullable: true
                description: Additional item metadata
                additionalProperties: true
        purchase_discounts:
          type: array
          nullable: true
          description: Array of cart-level discounts
          items:
            type: object
            properties:
              type:
                type: string
                enum: [prosent, verdi, ingen]
                example: prosent
              amount:
                type: integer
                description: Discount amount in øre
                example: 1000
              percentage:
                type: number
                nullable: true
                description: Discount percentage (0-100)
                example: 10
              reason:
                type: string
                nullable: true
                example: "Kundeklubb"
        purchase_subtotal:
          type: integer
          nullable: true
          description: Subtotal in øre (before discounts and tax)
          example: 10000
        purchase_total_discounts:
          type: integer
          nullable: true
          description: Total discount amount in øre
          example: 1000
        purchase_total_tax:
          type: integer
          nullable: true
          description: Total tax amount in øre
          example: 2000
        purchase_tip_amount:
          type: integer
          nullable: true
          description: Tip amount in øre
          example: 500
        purchase_note:
          type: string
          nullable: true
          description: Optional note/comment for the purchase
          example: "Customer requested delivery by 3 PM"
        purchase_payments:
          type: array
          description: List of payments connected to this purchase (usually one payment per purchase)
          items:
            type: object
            properties:
              id:
                type: integer
                description: Payment/charge ID
                example: 80
              stripe_charge_id:
                type: string
                nullable: true
                description: Stripe charge ID
                example: "ch_3Sbkk4FV5GyLGm1e0muKMt1e"
              stripe_payment_intent_id:
                type: string
                nullable: true
                description: Stripe payment intent ID
                example: "pi_3Sbkk4FV5GyLGm1e07tVG9ok"
              amount:
                type: integer
                description: Payment amount in øre
                example: 184900
              amount_refunded:
                type: integer
                description: Amount refunded in øre
                example: 0
              currency:
                type: string
                description: Currency code
                example: "nok"
              status:
                type: string
                description: Payment status
                example: "succeeded"
              method:
                type: string
                nullable: true
                description: Payment method code
                example: "card_present"
              code:
                type: string
                nullable: true
                description: SAF-T payment code
                example: "12002"
              transaction_code:
                type: string
                nullable: true
                description: SAF-T transaction code
                example: "11002"
              captured:
                type: boolean
                description: Whether payment is captured
                example: true
              refunded:
                type: boolean
                description: Whether payment is refunded
                example: false
              paid:
                type: boolean
                description: Whether payment is paid
                example: true
              paid_at:
                type: string
                format: date-time
                nullable: true
                description: Payment date/time in Oslo timezone
                example: "2025-12-07T17:23:36.000+01:00"
              tip_amount:
                type: integer
                nullable: true
                description: Tip amount in øre
                example: 0
              application_fee_amount:
                type: integer
                nullable: true
                description: Application fee amount in øre
              description:
                type: string
                nullable: true
                description: Payment description
                example: "Card payment"
              failure_code:
                type: string
                nullable: true
                description: Failure code if payment failed
              failure_message:
                type: string
                nullable: true
                description: Failure message if payment failed
              created_at:
                type: string
                format: date-time
                description: Payment creation date/time in Oslo timezone
                example: "2025-12-07T17:23:36.000+01:00"
              payment_method_id:
                type: string
                nullable: true
                description: Stripe payment method ID (from payment intent)
                example: "pm_xxx"
              capture_method:
                type: string
                nullable: true
                description: Capture method (automatic or manual)
                example: "automatic"
              confirmation_method:
                type: string
                nullable: true
                description: Confirmation method
                example: "automatic"
              receipt_email:
                type: string
                nullable: true
                description: Receipt email address
                example: "customer@example.com"
              statement_descriptor:
                type: string
                nullable: true
                description: Statement descriptor
              succeeded_at:
                type: string
                format: date-time
                nullable: true
                description: Payment intent succeeded date/time in Oslo timezone

    PosSession:
      type: object
      properties:
        id:
          type: integer
          example: 1
        store_id:
          type: integer
          example: 1
        pos_device_id:
          type: integer
          example: 1
        user_id:
          type: integer
          example: 1
        session_number:
          type: string
          description: Zero-padded 6-digit session number
          example: "000001"
        status:
          type: string
          enum: [open, closed, abandoned]
          example: open
        opening_balance:
          type: integer
          description: Opening cash balance in øre
          example: 0
        expected_cash:
          type: integer
          nullable: true
          description: Expected cash amount in øre
        actual_cash:
          type: integer
          nullable: true
          description: Actual cash count in øre
        cash_difference:
          type: integer
          nullable: true
          description: Cash difference in øre
        opening_notes:
          type: string
          nullable: true
          description: Free-text notes for session opening (e.g., shift information, initial observations, cashier notes)
          maxLength: 1000
        closing_notes:
          type: string
          nullable: true
          description: Free-text notes for session closing (e.g., cash discrepancies, end-of-shift observations, issues encountered)
          maxLength: 1000
        opening_data:
          type: object
          nullable: true
          additionalProperties: true
        closing_data:
          type: object
          nullable: true
          additionalProperties: true
        opened_at:
          type: string
          format: date-time
        closed_at:
          type: string
          format: date-time
          nullable: true
        session_device:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            device_name:
              type: string
        session_user:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
        transaction_count:
          type: integer
          description: Number of successful transactions
          example: 5
        total_amount:
          type: integer
          description: Total amount in øre
          example: 150000
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    PosSessionWithCharges:
      allOf:
        - $ref: '#/components/schemas/PosSession'
        - type: object
          properties:
            session_charges:
              type: array
              items:
                $ref: '#/components/schemas/SessionCharge'

    SessionCharge:
      type: object
      properties:
        id:
          type: integer
          example: 101
        stripe_charge_id:
          type: string
          example: "ch_1234567890abcdef"
        amount:
          type: integer
          description: Amount in øre
          example: 50000
        currency:
          type: string
          example: "nok"
        status:
          type: string
          example: "succeeded"
        payment_method:
          type: string
          example: "card"
        paid_at:
          type: string
          format: date-time
          nullable: true

    PosEvent:
      type: object
      properties:
        id:
          type: integer
          example: 1
        store_id:
          type: integer
          example: 1
        pos_device_id:
          type: integer
          nullable: true
        pos_device:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            device_name:
              type: string
        pos_session_id:
          type: integer
          nullable: true
        pos_session:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            session_number:
              type: string
        user_id:
          type: integer
          nullable: true
        user:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
        event_code:
          type: string
          description: SAF-T event code (PredefinedBasicID-13)
          example: "13012"
        event_type:
          type: string
          enum: [application, user, drawer, report, transaction, payment, session, other]
          example: transaction
        description:
          type: string
          nullable: true
        event_description:
          type: string
          nullable: true
          description: Human-readable event description
        related_charge_id:
          type: integer
          nullable: true
        event_data:
          type: object
          nullable: true
          additionalProperties: true
        occurred_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time

    XReport:
      type: object
      properties:
        session_id:
          type: integer
        session_number:
          type: string
        opened_at:
          type: string
          format: date-time
        report_generated_at:
          type: string
          format: date-time
        store:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
        device:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
        cashier:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
        opening_balance:
          type: integer
        transactions_count:
          type: integer
        total_amount:
          type: integer
          description: Total amount in øre
        vat_base:
          type: integer
          description: VAT base amount in øre
        vat_amount:
          type: integer
          description: VAT amount in øre
        vat_rate:
          type: number
          description: VAT rate percentage
        cash_amount:
          type: integer
        card_amount:
          type: integer
        mobile_amount:
          type: integer
        other_amount:
          type: integer
        total_tips:
          type: integer
        cash_drawer_opens:
          type: integer
        nullinnslag_count:
          type: integer

    ZReport:
      type: object
      properties:
        session_id:
          type: integer
        session_number:
          type: string
        opened_at:
          type: string
          format: date-time
        closed_at:
          type: string
          format: date-time
        report_generated_at:
          type: string
          format: date-time
        store:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
        device:
          type: object
          nullable: true
        cashier:
          type: object
          nullable: true
        opening_balance:
          type: integer
        expected_cash:
          type: integer
          nullable: true
        actual_cash:
          type: integer
          nullable: true
        cash_difference:
          type: integer
          nullable: true
        transactions_count:
          type: integer
        total_amount:
          type: integer
        vat_base:
          type: integer
        vat_amount:
          type: integer
        vat_rate:
          type: number
        cash_amount:
          type: integer
        card_amount:
          type: integer
        mobile_amount:
          type: integer
        other_amount:
          type: integer
        total_tips:
          type: integer
        cash_drawer_opens:
          type: integer
        nullinnslag_count:
          type: integer

    PosSessionClosing:
      type: object
      properties:
        id:
          type: integer
        store_id:
          type: integer
        closing_date:
          type: string
          format: date
        notes:
          type: string
          nullable: true
        sessions_count:
          type: integer
        total_sales:
          type: integer
        created_at:
          type: string
          format: date-time

    Receipt:
      type: object
      properties:
        id:
          type: integer
          example: 1
        store_id:
          type: integer
          example: 1
        pos_session_id:
          type: integer
          nullable: true
        charge_id:
          type: integer
          nullable: true
        user_id:
          type: integer
          nullable: true
        receipt_number:
          type: string
          example: "SAL-000001"
        receipt_type:
          type: string
          enum: [sales, return, copy, steb, provisional, training, delivery, correction]
          example: sales
        receipt_data:
          type: object
          description: Receipt data (store info, items, totals, etc.)
          additionalProperties: true
        printed:
          type: boolean
          example: false
        printed_at:
          type: string
          format: date-time
          nullable: true
        reprint_count:
          type: integer
          example: 0
        pos_session:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            session_number:
              type: string
        charge:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            stripe_charge_id:
              type: string
            amount:
              type: integer
        user:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ReceiptPrinter:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: Main Counter Printer
        printer_type:
          type: string
          enum: [epson, star, generic]
          example: epson
        printer_model:
          type: string
          nullable: true
          example: TM-m30III
        paper_width:
          type: string
          enum: [80, 58]
          example: '80'
        connection_type:
          type: string
          enum: [network, usb, bluetooth]
          example: network
        ip_address:
          type: string
          format: ipv4
          nullable: true
          example: 192.168.1.100
        port:
          type: integer
          example: 9100
        device_id:
          type: string
          example: local_printer
        use_https:
          type: boolean
          example: false
        timeout:
          type: integer
          example: 60000
        is_active:
          type: boolean
          example: true
        monitor_status:
          type: boolean
          example: false
        drawer_open_level:
          type: string
          enum: [low, high]
          example: low
        use_job_id:
          type: boolean
          example: false
        printer_metadata:
          type: object
          nullable: true
          additionalProperties: true
        last_used_at:
          type: string
          format: date-time
          nullable: true
        pos_device:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            device_name:
              type: string
        epos_url:
          type: string
          nullable: true
          description: ePOS-Print service URL (for network printers)
          example: http://192.168.1.100/cgi-bin/epos/service.cgi?devid=local_printer&timeout=60000
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    PaymentMethod:
      type: object
      properties:
        id:
          type: integer
          example: 1
        store_id:
          type: integer
          example: 1
        name:
          type: string
          description: Display name
          example: Kontant
        code:
          type: string
          description: Internal code
          example: cash
        provider:
          type: string
          enum: [stripe, cash, other]
          example: cash
        provider_method:
          type: string
          nullable: true
          description: Provider-specific method (e.g., "card_present" for Stripe)
          example: card_present
        enabled:
          type: boolean
          example: true
        pos_suitable:
          type: boolean
          description: Whether this payment method is suitable for physical POS
          example: true
        sort_order:
          type: integer
          example: 0
        background_color:
          type: string
          nullable: true
          description: Accent background color for the payment method button (CSS hex format with alpha at end, e.g., #4C4B39F0)
          example: "#4C4B39F0"
        icon_color:
          type: string
          nullable: true
          description: Color for the payment method icon (hex, e.g., #272b3d)
          example: "#272b3d"
        saf_t_payment_code:
          type: string
          nullable: true
          description: SAF-T payment code (PredefinedBasicID-12)
          example: "12001"
        saf_t_event_code:
          type: string
          nullable: true
          description: SAF-T event code (PredefinedBasicID-13)
          example: "13016"
        description:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Product:
      type: object
      properties:
        id:
          type: integer
          example: 1
        stripe_product_id:
          type: string
          nullable: true
          example: prod_123
        name:
          type: string
          example: Coffee
        description:
          type: string
          nullable: true
        type:
          type: string
          enum: [service, good]
          example: good
        active:
          type: boolean
          example: true
        shippable:
          type: boolean
          example: false
        url:
          type: string
          nullable: true
        images:
          type: array
          items:
            type: string
            format: uri
          description: Array of image URLs (signed URLs for security)
        no_price_in_pos:
          type: boolean
          description: If true, this product has no preset price and requires custom price input on POS.
          default: false
        product_price:
          type: object
          nullable: true
          description: Default/active price
          properties:
            id:
              type: string
            amount:
              type: integer
              description: Price in øre
            amount_formatted:
              type: string
            currency:
              type: string
            type:
              type: string
            is_default:
              type: boolean
        prices:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              amount:
                type: integer
              amount_formatted:
                type: string
              currency:
                type: string
              type:
                type: string
              is_default:
                type: boolean
        variants:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              stripe_product_id:
                type: string
                nullable: true
              stripe_price_id:
                type: string
                nullable: true
              sku:
                type: string
                nullable: true
              barcode:
                type: string
                nullable: true
              variant_name:
                type: string
              variant_options:
                type: array
                items:
                  type: object
                  properties:
                    name:
                      type: string
                    value:
                      type: string
              variant_price:
                type: object
                description: Variant price object (for FlutterFlow compatibility)
                properties:
                  amount:
                    type: integer
                    description: Price in øre. Returns 0 for variants without preset prices (custom price input on POS).
                  amount_formatted:
                    type: string
                    description: Formatted price string. Returns "0.00" for variants without preset prices.
              price_amount:
                type: integer
                nullable: false
                description: Price in øre (flattened field for backward compatibility). Returns 0 for variants without preset prices (custom price input on POS). Frontend should check if price_amount === 0 to enable custom price input.
              price_amount_formatted:
                type: string
                nullable: false
                description: Formatted price string (flattened field for backward compatibility). Returns "0.00" for variants without preset prices. Frontend should check if price_amount === 0 to enable custom price input.
              compare_at_price_amount:
                type: integer
                nullable: true
                description: Compare at price in øre (original price for discounts).
              compare_at_price_amount_formatted:
                type: string
                nullable: true
                description: Formatted compare at price string.
              currency:
                type: string
              no_price_in_pos:
                type: boolean
                description: If true, this variant has no preset price and requires custom price input on POS.
                default: false
              variant_inventory:
                type: object
                properties:
                  quantity:
                    type: integer
                    nullable: true
                  in_stock:
                    type: boolean
                  policy:
                    type: string
                    nullable: true
                  management:
                    type: string
                    nullable: true
                  tracked:
                    type: boolean
        variants_count:
          type: integer
        product_inventory:
          type: object
          properties:
            tracked:
              type: boolean
            total_quantity:
              type: integer
              nullable: true
            in_stock_variants:
              type: integer
            out_of_stock_variants:
              type: integer
            all_in_stock:
              type: boolean
              nullable: true
        tax_code:
          type: string
          nullable: true
        unit_label:
          type: string
          nullable: true
        statement_descriptor:
          type: string
          nullable: true
        collections:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              name:
                type: string
              handle:
                type: string
                nullable: true
          description: Collections this product belongs to
        package_dimensions:
          type: object
          nullable: true
        product_meta:
          type: object
          nullable: true
          additionalProperties: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Collection:
      type: object
      description: 'Collection object. Note: id 0 represents a fake "Ukategorisert" (Uncategorized) category that appears when there are products with no collection.'
      properties:
        id:
          type: integer
          description: 'Collection ID. Value 0 indicates the fake "Ukategorisert" category for uncategorized products.'
          example: 1
        name:
          type: string
          example: Summer Collection
        description:
          type: string
          nullable: true
          example: Products for summer season
        handle:
          type: string
          nullable: true
          example: summer-collection
        image_url:
          type: string
          nullable: true
          format: uri
        active:
          type: boolean
          example: true
        sort_order:
          type: integer
          example: 0
        products_count:
          type: integer
          description: Number of products in this collection
          example: 15
        metadata:
          type: object
          nullable: true
          additionalProperties: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          example: Error message
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          example:
            email:
              - The email field is required.

    ValidationErrorResponse:
      type: object
      properties:
        message:
          type: string
          example: The given data was invalid.
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          example:
            email:
              - The email field is required.
              - The email must be a valid email address.
            password:
              - The password field is required.

    PurchaseCart:
      type: object
      required:
        - items
        - total
      properties:
        items:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - product_id
              - quantity
              - unit_price
            properties:
              product_id:
                type: integer
                example: 123
              variant_id:
                type: integer
                nullable: true
                example: 456
              quantity:
                type: integer
                minimum: 1
                example: 2
              unit_price:
                type: integer
                description: Price per unit in minor units (øre)
                minimum: 0
              description:
                type: string
                nullable: true
                maxLength: 500
                description: Custom description for diverse products or products without price. This will be used on receipts instead of the product name. Useful for items like "Various items", "Custom service", etc.
                example: "Various items - customer selection"
                example: 5000
              discount_amount:
                type: integer
                description: Discount amount per unit in minor units
                default: 0
                example: 500
              tax_rate:
                type: number
                description: Tax rate (e.g., 0.25 for 25%)
                default: 0
                example: 0.25
              tax_inclusive:
                type: boolean
                description: Whether price includes tax
                default: true
                example: true
        discounts:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [prosent, verdi, ingen]
                example: prosent
              amount:
                type: integer
                description: Discount amount in minor units
                example: 1000
              percentage:
                type: number
                nullable: true
                description: Discount percentage (0-100)
                example: 10
              reason:
                type: string
                nullable: true
                example: Kundeklubb
        tip_amount:
          type: integer
          description: Tip amount in minor units
          default: 0
          example: 0
        customer_id:
          type: integer
          nullable: true
          description: Customer database ID (integer)
          example: 1
        customer_name:
          type: string
          nullable: true
          example: John Doe
        subtotal:
          type: integer
          description: Subtotal in minor units (before discounts and tax)
          example: 10000
        total_discounts:
          type: integer
          description: Total discount amount in minor units
          example: 1000
        total_tax:
          type: integer
          description: Total tax amount in minor units
          example: 2000
        total:
          type: integer
          description: Total amount in minor units
          minimum: 1
          example: 11000
        currency:
          type: string
          description: Currency code (ISO 3-letter)
          default: nok
          example: nok
        note:
          type: string
          nullable: true
          description: Optional note/comment for the purchase
          example: "Customer requested delivery by 3 PM"

    PurchaseMetadata:
      type: object
      description: Additional metadata
      properties:
        payment_intent_id:
          type: string
          description: Stripe payment intent ID (required for Stripe payments)
          example: pi_xxx
        deferred_payment:
          type: boolean
          description: Set to true to create a deferred payment (payment on pickup/later). Generates a delivery receipt per Kassasystemforskriften § 2-8-7.
          example: false
        deferred_reason:
          type: string
          description: Reason for deferred payment (e.g., "Payment on pickup", "Dry cleaning")
          example: "Payment on pickup"
        cashier_name:
          type: string
          example: John Doe
        device_id:
          type: integer
          example: 1
        description:
          type: string
          example: Purchase description

    PurchaseSinglePaymentRequest:
      type: object
      required:
        - pos_session_id
        - payment_method_code
        - cart
      properties:
        pos_session_id:
          type: integer
          description: ID of the active POS session
          example: 1
        payment_method_code:
          type: string
          description: Code of the payment method (e.g., "cash", "card", "card_present")
          example: cash
        cart:
          $ref: '#/components/schemas/PurchaseCart'
        metadata:
          $ref: '#/components/schemas/PurchaseMetadata'

    PurchaseSplitPaymentRequest:
      type: object
      required:
        - pos_session_id
        - payments
        - cart
      properties:
        pos_session_id:
          type: integer
          description: ID of the active POS session
          example: 1
        payments:
          type: array
          description: Array of payment methods and amounts
          minItems: 1
          items:
            type: object
            required:
              - payment_method_code
              - amount
            properties:
              payment_method_code:
                type: string
                example: cash
              amount:
                type: integer
                description: Payment amount in minor units (øre)
                minimum: 1
                example: 5000
              metadata:
                type: object
                description: Payment-specific metadata (e.g., payment_intent_id for Stripe)
                additionalProperties: true
                example:
                  payment_intent_id: pi_xxx
        cart:
          $ref: '#/components/schemas/PurchaseCart'
        metadata:
          $ref: '#/components/schemas/PurchaseMetadata'

  responses:
    UnauthorizedError:
      description: Authentication required or invalid token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            default:
              value:
                message: Unauthenticated.

security:
  - bearerAuth: []

